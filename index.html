<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schweizer Mundart-W√∂rterbuch - Vollversion v2.2</title>
    <style>
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --text-light: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #2563eb;
            --accent-hover: #1d4ed8;
            --accent-light: #eff6ff;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
            --box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-muted: #9ca3af;
            --text-light: #6b7280;
            --border-color: #374151;
            --accent-light: #1e3a5f;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.3);
            --box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); transition: background 0.3s, color 0.3s; }
        .header { background: var(--bg-secondary); box-shadow: var(--box-shadow); padding: 0; position: sticky; top: 0; z-index: 100; }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .header h1 { text-align: center; color: var(--text-primary); font-size: 24px; }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .theme-toggle { background: var(--bg-tertiary); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 18px; transition: background 0.2s; }
        .theme-toggle:hover { background: var(--border-color); }
        .nav { display: flex; justify-content: center; background: var(--bg-primary); flex-wrap: wrap; }
        .nav-btn { padding: 15px 30px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-size: 16px; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .nav-btn:hover { color: var(--accent-color); background: var(--accent-light); }
        .nav-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); background: var(--bg-secondary); }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        
        /* Statistik & Wort des Tages */
        .hero-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: linear-gradient(135deg, var(--accent-color), #7c3aed); color: white; padding: 25px; border-radius: 12px; text-align: center; }
        .stat-box h2 { font-size: 42px; margin-bottom: 5px; }
        .stat-box p { opacity: 0.9; font-size: 16px; }
        .wort-des-tages { background: var(--bg-secondary); padding: 25px; border-radius: 12px; box-shadow: var(--box-shadow); border-left: 4px solid var(--warning-color); }
        .wort-des-tages-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .wort-des-tages h3 { color: var(--warning-color); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .wort-des-tages .begriff { font-size: 28px; color: var(--accent-color); font-weight: 700; margin-bottom: 8px; }
        .wort-des-tages .bedeutung { color: var(--text-secondary); line-height: 1.5; }
        
        /* Alphabet Navigation */
        .alphabet-nav { background: var(--bg-secondary); padding: 15px; border-radius: 12px; box-shadow: var(--box-shadow); margin-bottom: 20px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .alphabet-nav::-webkit-scrollbar { height: 6px; }
        .alphabet-nav::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        .alphabet-btn { display: inline-block; width: 36px; height: 36px; line-height: 36px; text-align: center; background: var(--bg-tertiary); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--text-secondary); margin: 2px; transition: all 0.2s; }
        .alphabet-btn:hover { background: var(--accent-color); color: white; }
        .alphabet-btn.active { background: var(--accent-color); color: white; }
        
        /* Shuffle Button */
        .shuffle-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: transform 0.2s, box-shadow 0.2s; }
        .shuffle-btn:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        
        .search-box { background: var(--bg-secondary); padding: 25px; border-radius: 12px; box-shadow: var(--box-shadow); margin-bottom: 30px; }
        .search-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .search-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .form-grid { display: grid; gap: 15px; }
        .form-actions { margin-top: 20px; display: flex; gap: 10px; }
        .input { width: 100%; padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px; transition: border 0.2s; background: var(--bg-secondary); color: var(--text-primary); }
        .input:focus { outline: none; border-color: var(--accent-color); }
        select.input { cursor: pointer; }
        textarea.input { min-height: 120px; font-family: inherit; resize: vertical; max-height: 400px; }
        .btn { padding: 12px 24px; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; transition: background 0.2s; }
        .btn:hover { background: var(--accent-hover); }
        .btn:disabled { background: #d1d5db; cursor: not-allowed; }
        .btn-secondary { background: var(--text-muted); }
        .btn-secondary:hover:not(:disabled) { background: var(--text-secondary); }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: var(--success-color); }
        .btn-success:hover { background: #059669; }
        .card { background: var(--bg-secondary); padding: 20px; margin-bottom: 15px; border-radius: 10px; box-shadow: var(--card-shadow); }
        .card h3 { color: var(--accent-color); margin-bottom: 12px; font-size: 20px; }
        .card-row { margin: 8px 0; color: var(--text-secondary); line-height: 1.6; }
        .card-label { font-weight: 600; color: var(--text-primary); }
        .card-kategorie { display: inline-block; background: var(--accent-light); color: var(--accent-color); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; margin-top: 10px; }
        .empty { text-align: center; padding: 60px 20px; color: var(--text-light); font-size: 16px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .warning-box { background: #fef3c7; border: 2px solid var(--warning-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #92400e; }
        .success-box { background: #d1fae5; border: 2px solid var(--success-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #065f46; }
        .error-box { background: #fee2e2; border: 2px solid var(--danger-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #991b1b; }
        .info-box { background: #dbeafe; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #1e40af; }
        .info-content { background: var(--bg-secondary); padding: 30px; border-radius: 12px; box-shadow: var(--box-shadow); }
        .info-content h2 { color: var(--accent-color); margin: 25px 0 15px 0; font-size: 24px; }
        .info-content h2:first-child { margin-top: 0; }
        .info-content p { margin-bottom: 15px; line-height: 1.6; color: var(--text-secondary); }
        .info-content ul { margin-bottom: 15px; line-height: 1.8; margin-left: 20px; }
        .pending-badge { background: #fbbf24; color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; display: inline-block; margin-left: 8px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; }
        .tab-btn { padding: 12px 24px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-size: 15px; font-weight: 500; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .page-btn { padding: 8px 16px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-muted); font-weight: 500; }
        .page-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .page-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .spinner { border: 3px solid var(--border-color); border-top: 3px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--text-primary); color: var(--bg-primary); padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease-out; max-width: 400px; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { background: var(--success-color); color: white; }
        .toast.error { background: var(--danger-color); color: white; }
        .toast.warning { background: var(--warning-color); color: white; }
        .progress-bar { width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; margin-top: 15px; }
        .progress-fill { height: 100%; background: var(--accent-color); transition: width 0.3s ease; }
        .login-box { max-width: 400px; margin: 100px auto; background: var(--bg-secondary); padding: 40px; border-radius: 12px; box-shadow: var(--box-shadow); }
        .login-box h2 { margin-bottom: 25px; color: var(--text-primary); }
        .admin-table-container { width: 100%; overflow-x: scroll; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-top: 20px; background: var(--bg-secondary); border-radius: 8px; box-shadow: var(--box-shadow); max-height: 70vh; }
        .admin-table-container::-webkit-scrollbar { height: 12px; width: 12px; }
        .admin-table-container::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 10px; }
        .admin-table-container::-webkit-scrollbar-thumb { background: var(--text-light); border-radius: 10px; }
        .admin-table-container::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        .admin-table { width: 100%; min-width: 100%; border-collapse: collapse; display: table; table-layout: fixed; }
        .admin-table thead { background: var(--bg-tertiary); position: sticky; top: 0; z-index: 10; }
        .admin-table th { padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color); font-weight: 600; color: var(--text-primary); word-wrap: break-word; }
        .admin-table td { padding: 12px; border-bottom: 1px solid var(--border-color); word-wrap: break-word; vertical-align: top; }
        .admin-table tr:hover { background: var(--bg-tertiary); }
        .editable-cell { min-width: 80px; cursor: text; border: 1px solid transparent; padding: 4px; border-radius: 4px; word-wrap: break-word; white-space: pre-wrap; min-height: 30px; }
        .editable-cell:focus { outline: none; border-color: var(--accent-color); background: var(--bg-secondary); }
        .editable-cell:hover { border-color: var(--border-color); }
        .delete-row-btn { background: var(--danger-color); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .delete-row-btn:hover { background: #dc2626; }
        .checkbox { width: 18px; height: 18px; cursor: pointer; }
        .mapping-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; margin-bottom: 15px; }
        .mapping-arrow { font-size: 20px; color: var(--text-muted); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: var(--bg-tertiary); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px; color: var(--text-primary); }
        .modal-close:hover { background: var(--border-color); }
        .reim-section { margin: 20px 0; }
        .reim-section h3 { color: var(--accent-color); margin-bottom: 15px; font-size: 20px; padding-left: 10px; border-left: 4px solid var(--accent-color); }
        .search-hint { font-size: 13px; color: var(--text-light); margin-top: 8px; }
        
        /* Kategorie Filter Chips */
        .kategorie-filter { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .kategorie-chip { padding: 6px 14px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-secondary); transition: all 0.2s; }
        .kategorie-chip:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .kategorie-chip.active { background: var(--accent-color); border-color: var(--accent-color); color: white; }
        
        @media (max-width: 768px) {
            .nav-btn { padding: 12px 20px; font-size: 14px; }
            .search-grid { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .hero-section { grid-template-columns: 1fr; }
            .header h1 { font-size: 18px; }
            .alphabet-btn { width: 32px; height: 32px; line-height: 32px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div></div>
            <h1>üó£Ô∏è Schweizer Mundart-W√∂rterbuch</h1>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" title="Dark/Light Mode">üåô</button>
            </div>
        </div>
        <p style="text-align: center; color: var(--text-muted); padding: 0 20px 15px; border-bottom: 1px solid var(--border-color);">
            Dialekte aus Luzern, Aargau, Solothurn und Bern - Vollversion 2.2
        </p>
        <div class="nav" id="mainNav"></div>
    </div>
    <div class="container" id="content"></div>
    <div id="toastContainer"></div>
    <div id="modal" class="modal"></div>
    <script>
        var CONFIG = {
            SUPABASE_URL: 'https://owigtnvkqrhclqhfppxf.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93aWd0bnZrcXJoY2xxaGZwcHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjQyOTIsImV4cCI6MjA3NjIwMDI5Mn0.gN0tNzN73oa9Fr-zoFgLGlkat4SypGV5B3bzdZjYFyo',
            ADMIN_PASSWORD: 'mundart2024',
            ITEMS_PER_PAGE: 50,
            DEBOUNCE_DELAY: 400
        };
        
        var state = {
            currentView: 'woerterbuch',
            adminTab: 'freigaben',
            isAdmin: false,
            currentPageData: [],
            totalCount: 0,
            pendingChanges: [],
            currentPage: 1,
            currentEditIndex: 0,
            currentEditWord: null,
            isNewEntry: true,
            showUnreineReime: false,
            filter: { mundart: '', deutsch: '', wortart: '', reim: '', kategorie: '', buchstabe: '' },
            searchDebounceTimer: null,
            selectedRows: new Set(),
            csvData: [],
            wortarten: [],
            kategorien: [],
            isLoading: false,
            wortDesTages: null,
            darkMode: false
        };
        
        // Dark Mode
        function toggleTheme() {
            state.darkMode = !state.darkMode;
            document.documentElement.setAttribute('data-theme', state.darkMode ? 'dark' : 'light');
            document.querySelector('.theme-toggle').textContent = state.darkMode ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', state.darkMode);
        }
        
        function loadTheme() {
            var saved = localStorage.getItem('darkMode');
            if (saved === 'true') {
                state.darkMode = true;
                document.documentElement.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
        }
        
        function debounce(func, delay) {
            return function() {
                var args = arguments;
                var context = this;
                clearTimeout(state.searchDebounceTimer);
                state.searchDebounceTimer = setTimeout(function() {
                    func.apply(context, args);
                }, delay);
            };
        }
        
        function showToast(message, type) {
            var container = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 3000);
        }
        
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim().replace(/[<>]/g, '');
        }
        
        function showModal(title, content) {
            var modal = document.getElementById('modal');
            modal.innerHTML = '<div class="modal-content"><div class="modal-header"><h2>' + title + '</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>' + content + '</div>';
            modal.classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        
        // API Calls
        function supabaseCall(endpoint, options) {
            options = options || {};
            return fetch(CONFIG.SUPABASE_URL + '/rest/v1/' + endpoint, {
                method: options.method || 'GET',
                headers: Object.assign({
                    'apikey': CONFIG.SUPABASE_KEY,
                    'Authorization': 'Bearer ' + CONFIG.SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': options.headers && options.headers['Prefer'] ? options.headers['Prefer'] : 'return=representation'
                }, options.headers || {}),
                body: options.body
            }).then(function(res) {
                var totalCount = res.headers.get('content-range');
                if (totalCount) {
                    var match = totalCount.match(/\/(\d+)/);
                    if (match) state.totalCount = parseInt(match[1]);
                }
                if (!res.ok) {
                    return res.text().then(function(error) {
                        throw new Error('HTTP ' + res.status + ': ' + error);
                    });
                }
                if (options.method === 'DELETE' || res.status === 204) {
                    return { success: true };
                }
                return res.text().then(function(text) {
                    return text ? JSON.parse(text) : {};
                });
            }).catch(function(error) {
                console.error('API Error:', error);
                throw error;
            });
        }
        
        function loadPageData(page, filters) {
            state.isLoading = true;
            var offset = (page - 1) * CONFIG.ITEMS_PER_PAGE;
            var queryParts = [];
            
            if (filters.mundart && filters.mundart.trim()) {
                queryParts.push('begriff=ilike.*' + encodeURIComponent(filters.mundart.trim()) + '*');
            }
            if (filters.deutsch && filters.deutsch.trim()) {
                queryParts.push('synonyme=ilike.*' + encodeURIComponent(filters.deutsch.trim()) + '*');
            }
            if (filters.wortart && filters.wortart !== 'alle') {
                queryParts.push('wortart=eq.' + encodeURIComponent(filters.wortart));
            }
            if (filters.kategorie && filters.kategorie !== 'alle') {
                queryParts.push('kategorie=eq.' + encodeURIComponent(filters.kategorie));
            }
            if (filters.buchstabe && filters.buchstabe.trim()) {
                queryParts.push('begriff=ilike.' + encodeURIComponent(filters.buchstabe) + '*');
            }
            
            var url = 'woerter?select=*&order=begriff.asc&limit=' + CONFIG.ITEMS_PER_PAGE + '&offset=' + offset;
            if (queryParts.length > 0) {
                url += '&' + queryParts.join('&');
            }
            
            return supabaseCall(url, {
                headers: { 'Prefer': 'count=exact' }
            }).then(function(data) {
                state.currentPageData = data || [];
                state.isLoading = false;
                return data;
            });
        }
        
        function loadWortarten() {
            return supabaseCall('woerter?select=wortart&wortart=not.is.null&order=wortart.asc').then(function(data) {
                var unique = {};
                data.forEach(function(item) {
                    if (item.wortart) unique[item.wortart] = true;
                });
                state.wortarten = Object.keys(unique).sort();
                return state.wortarten;
            });
        }
        
        function loadKategorien() {
            return supabaseCall('woerter?select=kategorie&kategorie=not.is.null&order=kategorie.asc').then(function(data) {
                var unique = {};
                data.forEach(function(item) {
                    if (item.kategorie) unique[item.kategorie] = true;
                });
                state.kategorien = Object.keys(unique).sort();
                return state.kategorien;
            });
        }
        
        function loadTotalCount() {
            return supabaseCall('woerter?select=id&limit=1', {
                headers: { 'Prefer': 'count=exact' }
            });
        }
        
        function loadWortDesTages() {
            // Basierend auf dem Datum ein "zuf√§lliges" Wort ausw√§hlen
            var today = new Date();
            var dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            var seed = today.getFullYear() * 1000 + dayOfYear;
            var offset = seed % Math.max(1, state.totalCount - 1);
            
            return supabaseCall('woerter?select=*&limit=1&offset=' + offset).then(function(data) {
                if (data && data.length > 0) {
                    state.wortDesTages = data[0];
                }
                return state.wortDesTages;
            });
        }
        
        function loadRandomWord() {
            var randomOffset = Math.floor(Math.random() * Math.max(1, state.totalCount - 1));
            return supabaseCall('woerter?select=*&limit=1&offset=' + randomOffset).then(function(data) {
                if (data && data.length > 0) {
                    showModal('üé≤ Zuf√§lliges Wort', renderCardContent(data[0]));
                }
            });
        }
        
        function loadPendingChanges() {
            return supabaseCall('pending_changes?select=*&order=created_at.desc').then(function(data) {
                state.pendingChanges = data || [];
                return data;
            });
        }
        
        function loadData() {
            var content = document.getElementById('content');
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 20px;">Lade Daten...</p></div>';
            
            Promise.all([
                loadTotalCount(),
                loadWortarten(),
                loadKategorien(),
                loadPendingChanges(),
                loadPageData(1, state.filter)
            ]).then(function() {
                return loadWortDesTages();
            }).then(function() {
                render();
            }).catch(function(error) {
                console.error('Ladefehler:', error);
                document.getElementById('content').innerHTML = '<div class="error-box" style="max-width:800px;margin:40px auto;"><h2 style="margin-bottom: 15px;">‚ö†Ô∏è Verbindungsfehler</h2><p style="margin-bottom: 15px;"><strong>Fehler:</strong> ' + error.message + '</p><button class="btn" onclick="loadData()" style="margin-top: 15px;">üîÑ Erneut versuchen</button></div>';
            });
        }
        
        // Reimlexikon
        function normalizeForReim(text) {
            if (!text) return '';
            return text.toLowerCase().trim();
        }
        
        function phoneticNormalize(text) {
            if (!text) return '';
            var result = text.toLowerCase().trim();
            result = result.replace(/aa|ah/g, 'a');
            result = result.replace(/ee|eh/g, 'e');
            result = result.replace(/ii|ih/g, 'i');
            result = result.replace(/oo|oh/g, 'o');
            result = result.replace(/uu|uh/g, 'u');
            result = result.replace(/√§√§|√§h/g, '√§');
            result = result.replace(/√∂√∂|√∂h/g, '√∂');
            result = result.replace(/√º√º|√ºh/g, '√º');
            result = result.replace(/ou/g, 'au');
            result = result.replace(/√§i/g, 'ei');
            result = result.replace(/ai/g, 'ei');
            result = result.replace(/√∂i/g, 'eu');
            result = result.replace(/√§u/g, 'eu');
            result = result.replace(/oi/g, 'eu');
            result = result.replace(/eli$/g, 'li');
            result = result.replace(/√§$/g, 'e');
            result = result.replace(/scht/g, '#ST#');
            result = result.replace(/schp/g, '#SP#');
            result = result.replace(/sch/g, 'sh');
            result = result.replace(/#ST#/g, 'st');
            result = result.replace(/#SP#/g, 'sp');
            result = result.replace(/gg/g, 'g');
            result = result.replace(/ck/g, 'k');
            result = result.replace(/ff/g, 'f');
            result = result.replace(/ll/g, 'l');
            result = result.replace(/rr/g, 'r');
            result = result.replace(/ss/g, 's');
            result = result.replace(/tt/g, 't');
            result = result.replace(/pp/g, 'p');
            result = result.replace(/nn/g, 'n');
            result = result.replace(/mm/g, 'm');
            result = result.replace(/ch/g, 'k');
            result = result.replace(/tz/g, 's');
            result = result.replace(/ts/g, 's');
            result = result.replace(/z/g, 's');
            result = result.replace(/pf/g, 'f');
            result = result.replace(/v/g, 'f');
            result = result.replace(/w/g, 'f');
            result = result.replace(/sh/g, 's');
            return result;
        }
        
        function getVowelPattern(text) {
            var vowels = 'aeiou√§√∂√º';
            return text.split('').filter(function(c) { return vowels.includes(c); }).join('');
        }
        
        function phoneticSimilarity(word1, word2) {
            if (!word1 || !word2) return 0;
            var norm1 = phoneticNormalize(word1);
            var norm2 = phoneticNormalize(word2);
            var matrix = [];
            var i, j;
            for (i = 0; i <= norm1.length; i++) matrix[i] = [i];
            for (j = 0; j <= norm2.length; j++) matrix[0][j] = j;
            for (i = 1; i <= norm1.length; i++) {
                for (j = 1; j <= norm2.length; j++) {
                    if (norm1.charAt(i - 1) === norm2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
                    }
                }
            }
            var distance = matrix[norm1.length][norm2.length];
            var maxLength = Math.max(norm1.length, norm2.length);
            if (maxLength === 0) return 1;
            return 1 - (distance / maxLength);
        }
        
        function arePhoneticallySimilar(word1, word2) {
            var similarity = phoneticSimilarity(word1, word2);
            var lengthDiff = Math.abs(word1.length - word2.length);
            return similarity >= 0.6 && lengthDiff <= 2;
        }
        
        function searchReime(searchTerm, includeUnreine) {
            if (!searchTerm || !searchTerm.trim()) {
                return Promise.resolve({ rein: [], unrein: [] });
            }
            var normalizedSearch = normalizeForReim(searchTerm);
            return supabaseCall('woerter?select=*&begriff=ilike.' + encodeURIComponent(normalizedSearch) + '&limit=1').then(function(searchResult) {
                var searchReim = normalizedSearch;
                if (searchResult && searchResult.length > 0 && searchResult[0].reim) {
                    searchReim = normalizeForReim(searchResult[0].reim);
                }
                if (!searchReim) {
                    return { rein: [], unrein: [] };
                }
                return supabaseCall('woerter?select=*&reim=ilike.' + encodeURIComponent(searchReim) + '&order=begriff.asc&limit=200').then(function(reineReime) {
                    var rein = (reineReime || []).filter(function(w) {
                        return normalizeForReim(w.begriff) !== normalizedSearch;
                    });
                    var unrein = [];
                    if (includeUnreine && searchReim.length >= 2) {
                        var endung = searchReim.slice(-3);
                        return supabaseCall('woerter?select=*&reim=ilike.*' + encodeURIComponent(endung) + '&order=begriff.asc&limit=300').then(function(potentialUnreine) {
                            var phoneticSearchReim = phoneticNormalize(searchReim);
                            (potentialUnreine || []).forEach(function(wort) {
                                if (!wort.reim || !wort.begriff) return;
                                var normalizedBegriff = normalizeForReim(wort.begriff);
                                if (normalizedBegriff === normalizedSearch) return;
                                var normalizedReim = normalizeForReim(wort.reim);
                                if (normalizedReim === searchReim) return;
                                var phoneticReim = phoneticNormalize(normalizedReim);
                                if (phoneticReim === phoneticSearchReim) {
                                    unrein.push(wort);
                                } else if (arePhoneticallySimilar(normalizedReim, searchReim)) {
                                    var vowelPattern1 = getVowelPattern(normalizedReim);
                                    var vowelPattern2 = getVowelPattern(searchReim);
                                    if (vowelPattern1 === vowelPattern2 && vowelPattern1.length > 0) {
                                        unrein.push(wort);
                                    }
                                }
                            });
                            return { rein: rein, unrein: unrein };
                        });
                    }
                    return { rein: rein, unrein: unrein };
                });
            });
        }
        
        // Export
        function exportAllCSV() {
            showToast('Exportiere alle Eintr√§ge...', 'warning');
            var allData = [];
            var pageSize = 1000;
            var offset = 0;
            function loadBatch() {
                return supabaseCall('woerter?select=*&order=begriff.asc&limit=' + pageSize + '&offset=' + offset).then(function(batch) {
                    if (batch && batch.length > 0) {
                        allData = allData.concat(batch);
                        offset += pageSize;
                        if (batch.length < pageSize) {
                            return allData;
                        }
                        return loadBatch();
                    }
                    return allData;
                });
            }
            loadBatch().then(function(data) {
                var headers = ['Begriff', 'Reim', 'Wortart', 'Synonyme', 'Bedeutung', 'Beispielsatz', 'Bemerkung', 'Kategorie'];
                var rows = [headers];
                data.forEach(function(w) {
                    rows.push([
                        w.begriff || '',
                        w.reim || '',
                        w.wortart || '',
                        w.synonyme || '',
                        w.bedeutung || '',
                        w.beispielsatz || '',
                        w.bemerkung || '',
                        w.kategorie || ''
                    ]);
                });
                var csvContent = rows.map(function(row) {
                    return row.map(function(cell) {
                        var str = String(cell).replace(/"/g, '""');
                        return str.includes(',') || str.includes('"') || str.includes('\n') ? '"' + str + '"' : str;
                    }).join(',');
                }).join('\n');
                var blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'mundart-export-' + data.length + '-eintraege-' + new Date().toISOString().split('T')[0] + '.csv';
                link.click();
                showToast('‚úì ' + data.length + ' Eintr√§ge exportiert!', 'success');
            });
        }
        
        function changePage(page) {
            var totalPages = Math.ceil(state.totalCount / CONFIG.ITEMS_PER_PAGE);
            state.currentPage = Math.max(1, Math.min(page, totalPages));
            window.scrollTo(0, 0);
            loadPageData(state.currentPage, state.filter).then(function() {
                render();
            });
        }
        
        function filterByBuchstabe(buchstabe) {
            state.filter.buchstabe = buchstabe;
            state.currentPage = 1;
            loadPageData(1, state.filter).then(function() {
                render();
            });
        }
        
        function filterByKategorie(kategorie) {
            state.filter.kategorie = kategorie === state.filter.kategorie ? '' : kategorie;
            state.currentPage = 1;
            loadPageData(1, state.filter).then(function() {
                render();
            });
        }
        
        function renderCardContent(w) {
            var html = '<h3 style="color: var(--accent-color); font-size: 24px; margin-bottom: 15px;">' + (w.begriff || '') + '</h3>';
            if (w.reim) html += '<div class="card-row"><span class="card-label">Reim:</span> ' + w.reim + '</div>';
            if (w.wortart) html += '<div class="card-row"><span class="card-label">Wortart:</span> ' + w.wortart + '</div>';
            if (w.synonyme) html += '<div class="card-row"><span class="card-label">Synonyme:</span> ' + formatWithLineBreaks(w.synonyme) + '</div>';
            if (w.bedeutung) html += '<div class="card-row"><span class="card-label">Bedeutung:</span> ' + formatWithLineBreaks(w.bedeutung) + '</div>';
            if (w.beispielsatz) html += '<div class="card-row"><span class="card-label">Beispiel:</span> <em>"' + formatWithLineBreaks(w.beispielsatz) + '"</em></div>';
            if (w.bemerkung) html += '<div class="card-row"><span class="card-label">Bemerkung:</span> ' + formatWithLineBreaks(w.bemerkung) + '</div>';
            if (w.kategorie) html += '<div class="card-kategorie">' + w.kategorie + '</div>';
            return html;
        }
        
        function renderCard(w) {
            var html = '<div class="card"><h3>' + (w.begriff || '') + '</h3>';
            if (w.reim) html += '<div class="card-row"><span class="card-label">Reim:</span> ' + w.reim + '</div>';
            if (w.wortart) html += '<div class="card-row"><span class="card-label">Wortart:</span> ' + w.wortart + '</div>';
            if (w.synonyme) html += '<div class="card-row"><span class="card-label">Synonyme:</span> ' + formatWithLineBreaks(w.synonyme) + '</div>';
            if (w.bedeutung) html += '<div class="card-row"><span class="card-label">Bedeutung:</span> ' + formatWithLineBreaks(w.bedeutung) + '</div>';
            if (w.beispielsatz) html += '<div class="card-row"><span class="card-label">Beispiel:</span> <em>"' + formatWithLineBreaks(w.beispielsatz) + '"</em></div>';
            if (w.bemerkung) html += '<div class="card-row"><span class="card-label">Bemerkung:</span> ' + formatWithLineBreaks(w.bemerkung) + '</div>';
            if (w.kategorie) html += '<div class="card-kategorie">' + w.kategorie + '</div>';
            html += '</div>';
            return html;
        }
        
        function formatWithLineBreaks(text) {
            if (!text) return '';
            return text.replace(/\n/g, '<br>');
        }
        
        // W√∂rterbuch View
        function renderWoerterbuch() {
            var totalPages = Math.ceil(state.totalCount / CONFIG.ITEMS_PER_PAGE);
            
            // Hero Section mit Statistik und Wort des Tages
            var html = '<div class="hero-section">';
            html += '<div class="stat-box"><h2>' + state.totalCount.toLocaleString('de-CH') + '</h2><p>Mundart-W√∂rter im W√∂rterbuch</p></div>';
            if (state.wortDesTages) {
                html += '<div class="wort-des-tages"><div class="wort-des-tages-header"><h3>‚≠ê Wort des Tages</h3><button class="shuffle-btn" onclick="loadRandomWord()">üé≤ Zuf√§lliges Wort</button></div>';
                html += '<div class="begriff">' + state.wortDesTages.begriff + '</div>';
                html += '<div class="bedeutung">' + (state.wortDesTages.synonyme || state.wortDesTages.bedeutung || '') + '</div></div>';
            }
            html += '</div>';
            
            // Alphabet Navigation
            html += '<div class="alphabet-nav">';
            var alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ√Ñ√ñ√ú'.split('');
            alphabet.forEach(function(letter) {
                var isActive = state.filter.buchstabe.toUpperCase() === letter;
                html += '<button class="alphabet-btn' + (isActive ? ' active' : '') + '" onclick="filterByBuchstabe(\'' + letter + '\')">' + letter + '</button>';
            });
            html += '<button class="alphabet-btn' + (!state.filter.buchstabe ? ' active' : '') + '" onclick="filterByBuchstabe(\'\')">Alle</button>';
            html += '</div>';
            
            // Suchbox
            html += '<div class="search-box"><div class="search-grid">';
            html += '<input type="text" id="search-mundart" class="input" placeholder="Mundartbegriff suchen..." value="' + state.filter.mundart + '">';
            html += '<input type="text" id="search-deutsch" class="input" placeholder="Deutsche Entsprechung..." value="' + state.filter.deutsch + '">';
            html += '<select id="search-wortart" class="input"><option value="alle">Alle Wortarten</option>';
            state.wortarten.forEach(function(w) {
                html += '<option value="' + w + '"' + (state.filter.wortart === w ? ' selected' : '') + '>' + w + '</option>';
            });
            html += '</select></div>';
            
            // Kategorie Filter
            html += '<div class="kategorie-filter">';
            html += '<span class="kategorie-chip' + (!state.filter.kategorie ? ' active' : '') + '" onclick="filterByKategorie(\'\')">Alle Kategorien</span>';
            state.kategorien.forEach(function(k) {
                html += '<span class="kategorie-chip' + (state.filter.kategorie === k ? ' active' : '') + '" onclick="filterByKategorie(\'' + k + '\')">' + k + '</span>';
            });
            html += '</div>';
            
            html += '<div class="search-hint">üí° Tipp: Dr√ºcke Enter oder warte kurz nach der Eingabe f√ºr die Suche</div>';
            html += '<div style="margin-top: 10px; color: var(--text-muted); font-size: 14px;">';
            html += state.totalCount + ' Eintr√§ge gefunden';
            if (totalPages > 1) {
                html += ' (Seite ' + state.currentPage + ' von ' + totalPages + ')';
            }
            html += '</div></div>';
            
            if (state.isLoading) {
                html += '<div class="loading"><div class="spinner"></div></div>';
            } else if (state.currentPageData.length === 0) {
                html += '<div class="empty">Keine Eintr√§ge gefunden</div>';
            } else {
                state.currentPageData.forEach(function(w) { html += renderCard(w); });
            }
            
            if (totalPages > 1) {
                html += renderPagination(totalPages);
            }
            
            return html;
        }
        
        function renderPagination(totalPages) {
            var html = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 30px; padding: 20px;">';
            if (state.currentPage > 1) {
                html += '<button onclick="changePage(' + (state.currentPage - 1) + ')" class="page-btn">‚Üê Zur√ºck</button>';
            }
            html += '<span style="padding: 0 15px; color: var(--text-muted); font-weight: 500;">Seite ' + state.currentPage + ' von ' + totalPages + '</span>';
            var startPage = Math.max(1, state.currentPage - 2);
            var endPage = Math.min(totalPages, state.currentPage + 2);
            if (startPage > 1) {
                html += '<button onclick="changePage(1)" class="page-btn">1</button>';
                if (startPage > 2) html += '<span style="padding: 0 5px; color: var(--text-light);">...</span>';
            }
            for (var i = startPage; i <= endPage; i++) {
                var isActive = i === state.currentPage;
                html += '<button onclick="changePage(' + i + ')" class="page-btn' + (isActive ? ' active' : '') + '">' + i + '</button>';
            }
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span style="padding: 0 5px; color: var(--text-light);">...</span>';
                html += '<button onclick="changePage(' + totalPages + ')" class="page-btn">' + totalPages + '</button>';
            }
            if (state.currentPage < totalPages) {
                html += '<button onclick="changePage(' + (state.currentPage + 1) + ')" class="page-btn">Weiter ‚Üí</button>';
            }
            html += '</div>';
            return html;
        }
        
        // Reimlexikon View
        var reimResults = { rein: [], unrein: [] };
        var reimLoading = false;
        
        function renderReimlexikon() {
            var searchTerm = state.filter.reim || '';
            var html = '<div class="search-box">';
            html += '<input type="text" id="search-reim" class="input" placeholder="Mundartbegriff eingeben (z.B. singe)..." value="' + searchTerm + '">';
            html += '<div class="search-hint">üí° Dr√ºcke Enter oder warte kurz nach der Eingabe</div>';
            if (searchTerm.trim()) {
                html += '<div style="margin-top: 15px;"><label style="display: flex; align-items: center; cursor: pointer;">';
                html += '<input type="checkbox" id="toggle-unreine"' + (state.showUnreineReime ? ' checked' : '') + ' style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">';
                html += '<span>Auch unreine Reime anzeigen</span></label></div>';
            }
            html += '</div>';
            if (reimLoading) {
                html += '<div class="loading"><div class="spinner"></div><p style="margin-top: 15px;">Suche Reime...</p></div>';
            } else if (searchTerm.trim()) {
                html += '<div class="reim-section"><h3>Reine Reime (' + reimResults.rein.length + ')</h3>';
                if (reimResults.rein.length === 0) {
                    html += '<div class="empty">Keine reinen Reime gefunden</div>';
                } else {
                    reimResults.rein.forEach(function(w) { html += renderCard(w); });
                }
                html += '</div>';
                if (state.showUnreineReime) {
                    html += '<div class="reim-section"><h3>Unreine Reime (' + reimResults.unrein.length + ')</h3>';
                    if (reimResults.unrein.length === 0) {
                        html += '<div class="empty">Keine unreinen Reime gefunden</div>';
                    } else {
                        reimResults.unrein.forEach(function(w) { html += renderCard(w); });
                    }
                    html += '</div>';
                }
            } else {
                html += '<div class="empty">Gib einen Mundartbegriff ein, um Reime zu finden</div>';
            }
            return html;
        }
        
        function doReimSearch() {
            var searchTerm = state.filter.reim;
            if (!searchTerm || !searchTerm.trim()) {
                reimResults = { rein: [], unrein: [] };
                render();
                return;
            }
            reimLoading = true;
            render();
            searchReime(searchTerm, state.showUnreineReime).then(function(results) {
                reimResults = results;
                reimLoading = false;
                render();
            }).catch(function(error) {
                console.error('Reimsuche Fehler:', error);
                reimLoading = false;
                render();
            });
        }
        
        // Bearbeiten View
        function renderBearbeiten() {
            var wort = state.currentEditWord || {};
            var html = '<div class="success-box"><strong>‚ú® Hilf mit, das W√∂rterbuch zu erweitern!</strong><br>';
            html += 'Bearbeite einen bestehenden Begriff. Alle √Ñnderungen werden gepr√ºft.</div>';
            
            html += '<div class="search-box" style="margin-bottom: 20px;"><div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">';
            html += '<input type="text" id="search-edit-begriff" class="input" placeholder="Begriff suchen zum Bearbeiten..." style="flex: 1; min-width: 250px;">';
            html += '<button class="btn" onclick="searchBegriffToEdit()">üîç Suchen</button>';
            html += '</div><div id="search-suggestions" style="margin-top: 10px;"></div></div>';
            
            html += '<div class="search-box"><div class="toolbar">';
            html += '<h2>Bearbeiten:</h2>';
            html += '<button class="btn btn-success" onclick="toggleNewEntry()">+ Neuer Begriff</button>';
            html += '</div>';
            html += '<form id="edit-form" onsubmit="saveFormEntry(event); return false;"><div class="form-grid">';
            html += '<input type="text" name="begriff" class="input" placeholder="Mundartbegriff * (z.B. aab√§ndle)" value="' + (wort.begriff || '') + '"' + (!state.isNewEntry ? ' readonly style="background: var(--bg-tertiary);"' : '') + ' required>';
            html += '<input type="text" name="reim" class="input" placeholder="Reim (z.B. √§ndle)" value="' + (wort.reim || '') + '">';
            html += '<input type="text" name="wortart" class="input" placeholder="Wortart (z.B. Verb)" value="' + (wort.wortart || '') + '">';
            html += '<textarea name="synonyme" class="input" placeholder="Synonyme / Deutsche √úbersetzung" rows="2" style="min-height: 60px;">' + (wort.synonyme || '') + '</textarea>';
            html += '<textarea name="bedeutung" class="input" placeholder="Bedeutung" rows="4">' + (wort.bedeutung || '') + '</textarea>';
            html += '<textarea name="beispielsatz" class="input" placeholder="Beispielsatz" rows="3">' + (wort.beispielsatz || '') + '</textarea>';
            html += '<textarea name="bemerkung" class="input" placeholder="Bemerkungen" rows="3">' + (wort.bemerkung || '') + '</textarea>';
            html += '</div><div class="form-actions">';
            html += '<button type="submit" class="btn">√Ñnderungen vorschlagen</button>';
            html += '</div></form></div>';
            return html;
        }
        
        function searchBegriffToEdit() {
            var searchInput = document.getElementById('search-edit-begriff');
            if (!searchInput || !searchInput.value.trim()) {
                showToast('Bitte einen Begriff eingeben', 'warning');
                return;
            }
            var searchTerm = searchInput.value.trim();
            var searchTermLower = searchTerm.toLowerCase();
            supabaseCall('woerter?select=*&begriff=ilike.*' + encodeURIComponent(searchTerm) + '*&limit=10&order=begriff.asc').then(function(results) {
                var suggestionsDiv = document.getElementById('search-suggestions');
                if (!suggestionsDiv) return;
                if (results.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="warning-box">Kein Begriff gefunden. Du kannst ihn als neuen Begriff hinzuf√ºgen!</div>';
                    return;
                }
                // Exakter Treffer? Direkt laden!
                var exactMatch = results.find(function(w) {
                    return w.begriff.toLowerCase() === searchTermLower;
                });
                if (exactMatch) {
                    selectBegriffToEdit(exactMatch);
                    suggestionsDiv.innerHTML = '';
                    return;
                }
                // Nur ein Ergebnis? Direkt laden!
                if (results.length === 1) {
                    selectBegriffToEdit(results[0]);
                    suggestionsDiv.innerHTML = '';
                    return;
                }
                // Mehrere Ergebnisse: Vorschl√§ge anzeigen
                var html = '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                results.forEach(function(w) {
                    html += '<button class="btn btn-secondary" onclick=\'selectBegriffToEdit(' + JSON.stringify(w).replace(/'/g, "\\'") + ')\' style="padding: 6px 12px; font-size: 14px;">' + w.begriff + '</button>';
                });
                html += '</div>';
                suggestionsDiv.innerHTML = html;
            });
        }
        
        function selectBegriffToEdit(wort) {
            state.currentEditWord = wort;
            state.isNewEntry = false;
            render();
            showToast('Begriff "' + wort.begriff + '" geladen', 'success');
        }
        
        function toggleNewEntry() {
            state.isNewEntry = !state.isNewEntry;
            state.currentEditWord = null;
            render();
        }
        
        function saveFormEntry(event) {
            event.preventDefault();
            var formData = new FormData(event.target);
            var begriff = formData.get('begriff').trim();
            if (!begriff || begriff.length < 2) {
                showToast('Begriff muss mindestens 2 Zeichen lang sein', 'error');
                return;
            }
            var data = {
                action: state.isNewEntry ? 'create' : 'edit',
                wort_id: state.isNewEntry ? null : (state.currentEditWord ? state.currentEditWord.id : null),
                begriff: sanitizeInput(begriff),
                reim: sanitizeInput(formData.get('reim')) || null,
                wortart: sanitizeInput(formData.get('wortart')) || null,
                synonyme: sanitizeInput(formData.get('synonyme')) || null,
                bedeutung: sanitizeInput(formData.get('bedeutung')) || null,
                beispielsatz: sanitizeInput(formData.get('beispielsatz')) || null,
                bemerkung: sanitizeInput(formData.get('bemerkung')) || null,
                status: 'pending',
                created_at: new Date().toISOString()
            };
            supabaseCall('pending_changes', {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Prefer': 'return=representation' }
            }).then(function() {
                showToast(state.isNewEntry ? 'Neuer Begriff vorgeschlagen! ‚úì' : '√Ñnderung vorgeschlagen! ‚úì', 'success');
                state.isNewEntry = true;
                state.currentEditWord = null;
                return loadPendingChanges();
            }).then(function() {
                render();
            }).catch(function(error) {
                showToast('Fehler beim Speichern: ' + error.message, 'error');
            });
        }
        
        // Admin Views
        function renderAdmin() {
            var pendingCount = state.pendingChanges.length;
            var tabs = '<div class="tabs">';
            tabs += '<button class="tab-btn' + (state.adminTab === 'freigaben' ? ' active' : '') + '" onclick="changeAdminTab(\'freigaben\')">Freigaben' + (pendingCount > 0 ? '<span class="pending-badge">' + pendingCount + '</span>' : '') + '</button>';
            tabs += '<button class="tab-btn' + (state.adminTab === 'tabelle' ? ' active' : '') + '" onclick="changeAdminTab(\'tabelle\')">Eintr√§ge bearbeiten</button>';
            tabs += '<button class="tab-btn' + (state.adminTab === 'export' ? ' active' : '') + '" onclick="changeAdminTab(\'export\')">Export/Import</button>';
            tabs += '</div>';
            if (state.adminTab === 'freigaben') {
                return tabs + renderFreigaben(pendingCount);
            } else if (state.adminTab === 'tabelle') {
                return tabs + renderAdminTable();
            } else if (state.adminTab === 'export') {
                return tabs + renderExportImport();
            }
        }
        
        function renderFreigaben(pendingCount) {
            var html = '<div style="margin: 20px 0;"><h2>Ausstehende √Ñnderungen (' + pendingCount + ')</h2>';
            if (pendingCount > 0) {
                html += '<button class="btn" onclick="approveAllChanges()" style="margin-top: 10px;">‚úì Alle freigeben</button>';
            }
            html += '</div>';
            if (pendingCount === 0) {
                html += '<div class="empty">Keine ausstehenden √Ñnderungen</div>';
            } else {
                state.pendingChanges.forEach(function(c) {
                    html += '<div class="card"><div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">';
                    html += '<div><h3>' + c.begriff + '</h3><span class="pending-badge" style="margin-left: 0;">' + (c.action === 'create' ? 'Neuer Eintrag' : 'Bearbeitung') + '</span></div>';
                    html += '<div style="display: flex; gap: 8px;">';
                    html += '<button class="btn" style="padding: 8px 16px;" onclick="approveChange(' + c.id + ')">‚úì Freigeben</button>';
                    html += '<button class="btn btn-danger" style="padding: 8px 16px;" onclick="rejectChange(' + c.id + ')">‚úó Ablehnen</button>';
                    html += '</div></div>';
                    if (c.reim) html += '<div class="card-row"><span class="card-label">Reim:</span> ' + c.reim + '</div>';
                    if (c.wortart) html += '<div class="card-row"><span class="card-label">Wortart:</span> ' + c.wortart + '</div>';
                    if (c.synonyme) html += '<div class="card-row"><span class="card-label">Synonyme:</span> ' + c.synonyme + '</div>';
                    if (c.bedeutung) html += '<div class="card-row"><span class="card-label">Bedeutung:</span> ' + c.bedeutung + '</div>';
                    if (c.beispielsatz) html += '<div class="card-row"><span class="card-label">Beispiel:</span> <em>"' + c.beispielsatz + '"</em></div>';
                    if (c.bemerkung) html += '<div class="card-row"><span class="card-label">Bemerkung:</span> ' + c.bemerkung + '</div>';
                    html += '<div class="card-row" style="font-size: 13px; color: var(--text-light); margin-top: 10px;">Eingereicht: ' + new Date(c.created_at).toLocaleString('de-CH') + '</div>';
                    html += '</div>';
                });
            }
            return html;
        }
        
        function renderAdminTable() {
            var totalPages = Math.ceil(state.totalCount / CONFIG.ITEMS_PER_PAGE);
            var html = '<div class="info-box"><strong>üí° Tipps:</strong><br>‚Ä¢ Klicke in eine Zelle zum Bearbeiten (√Ñnderungen werden automatisch gespeichert)<br>‚Ä¢ Nutze die Suche oben zum Filtern</div>';
            html += '<div class="search-box"><input type="text" id="admin-search" class="input" placeholder="Eintr√§ge durchsuchen..." value="' + state.filter.mundart + '">';
            html += '<div style="margin-top: 10px; color: var(--text-muted);">' + state.totalCount + ' Eintr√§ge total (Seite ' + state.currentPage + ' von ' + totalPages + ')</div></div>';
            html += '<div class="admin-table-container"><table class="admin-table"><thead><tr>';
            html += '<th style="width: 40px;">‚úó</th>';
            html += '<th style="width: 12%;">Begriff</th>';
            html += '<th style="width: 8%;">Reim</th>';
            html += '<th style="width: 10%;">Wortart</th>';
            html += '<th style="width: 15%;">Synonyme</th>';
            html += '<th style="width: 18%;">Bedeutung</th>';
            html += '<th style="width: 15%;">Beispielsatz</th>';
            html += '<th style="width: 10%;">Kategorie</th>';
            html += '</tr></thead><tbody>';
            state.currentPageData.forEach(function(w, i) {
                html += '<tr style="' + (i % 2 === 0 ? 'background: var(--bg-tertiary);' : '') + '">';
                html += '<td style="text-align: center;"><button class="delete-row-btn" onclick="deleteRow(' + w.id + ')">‚úó</button></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ', \'begriff\', this.textContent.trim())" style="font-weight: 600;">' + (w.begriff || '') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ', \'reim\', this.textContent.trim())">' + (w.reim || '') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ', \'wortart\', this.textContent.trim())">' + (w.wortart || '') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ', \'synonyme\', this.textContent.trim())">' + (w.synonyme || '') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ', \'bedeutung\', this.textContent.trim())">' + (w.bedeutung || '') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ', \'beispielsatz\', this.textContent.trim())">' + (w.beispielsatz || '') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ', \'kategorie\', this.textContent.trim())">' + (w.kategorie || '') + '</div></td>';
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            if (totalPages > 1) {
                html += renderPagination(totalPages);
            }
            return html;
        }
        
        function renderExportImport() {
            var html = '<div class="search-box" style="max-width: 600px; margin: 40px auto;">';
            html += '<h2 style="margin-bottom: 20px;">Daten exportieren / importieren</h2>';
            html += '<p style="color: var(--text-muted); margin-bottom: 20px;">Exportiere oder importiere die W√∂rterbuch-Daten als CSV.</p>';
            html += '<button class="btn btn-success" onclick="exportAllCSV()" style="width: 100%; padding: 15px; font-size: 16px; margin-bottom: 15px;">üì• Alle ' + state.totalCount + ' Eintr√§ge exportieren</button>';
            html += '<button class="btn" onclick="document.getElementById(\'csv-upload\').click()" style="width: 100%; padding: 15px; font-size: 16px;">üì§ CSV importieren</button>';
            html += '<input type="file" id="csv-upload" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">';
            html += '</div>';
            return html;
        }
        
        function changeAdminTab(tab) {
            state.adminTab = tab;
            render();
        }
        
        function updateCell(id, field, value) {
            var data = {};
            data[field] = value || null;
            supabaseCall('woerter?id=eq.' + id, {
                method: 'PATCH',
                body: JSON.stringify(data)
            }).then(function() {
                // Stille Aktualisierung
            }).catch(function(error) {
                showToast('Fehler beim Speichern: ' + error.message, 'error');
            });
        }
        
        function deleteRow(id) {
            if (!confirm('Eintrag wirklich l√∂schen?')) return;
            supabaseCall('woerter?id=eq.' + id, { method: 'DELETE' }).then(function() {
                showToast('Eintrag gel√∂scht', 'success');
                return loadPageData(state.currentPage, state.filter);
            }).then(function() {
                loadTotalCount();
                render();
            }).catch(function(error) {
                showToast('Fehler: ' + error.message, 'error');
            });
        }
        
        function approveChange(id) {
            var change = state.pendingChanges.find(function(c) { return c.id === id; });
            if (!change) return;
            var promise;
            if (change.action === 'create') {
                promise = supabaseCall('woerter', {
                    method: 'POST',
                    body: JSON.stringify({
                        begriff: change.begriff,
                        reim: change.reim,
                        wortart: change.wortart,
                        synonyme: change.synonyme,
                        bedeutung: change.bedeutung,
                        beispielsatz: change.beispielsatz,
                        bemerkung: change.bemerkung
                    })
                });
            } else if (change.action === 'edit') {
                promise = supabaseCall('woerter?id=eq.' + change.wort_id, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        begriff: change.begriff,
                        reim: change.reim,
                        wortart: change.wortart,
                        synonyme: change.synonyme,
                        bedeutung: change.bedeutung,
                        beispielsatz: change.beispielsatz,
                        bemerkung: change.bemerkung
                    })
                });
            }
            promise.then(function() {
                return supabaseCall('pending_changes?id=eq.' + id, { method: 'DELETE' });
            }).then(function() {
                showToast('√Ñnderung freigegeben! ‚úì', 'success');
                return loadData();
            }).catch(function(error) {
                showToast('Fehler: ' + error.message, 'error');
            });
        }
        
        function rejectChange(id) {
            if (!confirm('Diese √Ñnderung wirklich ablehnen?')) return;
            supabaseCall('pending_changes?id=eq.' + id, { method: 'DELETE' }).then(function() {
                showToast('√Ñnderung abgelehnt.', 'warning');
                return loadPendingChanges();
            }).then(function() {
                render();
            }).catch(function(error) {
                showToast('Fehler: ' + error.message, 'error');
            });
        }
        
        function approveAllChanges() {
            if (!confirm(state.pendingChanges.length + ' √Ñnderungen freigeben?')) return;
            var promises = state.pendingChanges.map(function(change) {
                var p;
                if (change.action === 'create') {
                    p = supabaseCall('woerter', {
                        method: 'POST',
                        body: JSON.stringify({
                            begriff: change.begriff,
                            reim: change.reim,
                            wortart: change.wortart,
                            synonyme: change.synonyme,
                            bedeutung: change.bedeutung,
                            beispielsatz: change.beispielsatz,
                            bemerkung: change.bemerkung
                        })
                    });
                } else {
                    p = supabaseCall('woerter?id=eq.' + change.wort_id, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            begriff: change.begriff,
                            reim: change.reim,
                            wortart: change.wortart,
                            synonyme: change.synonyme,
                            bedeutung: change.bedeutung,
                            beispielsatz: change.beispielsatz,
                            bemerkung: change.bemerkung
                        })
                    });
                }
                return p.then(function() {
                    return supabaseCall('pending_changes?id=eq.' + change.id, { method: 'DELETE' });
                });
            });
            Promise.all(promises).then(function() {
                showToast('Alle √Ñnderungen freigegeben! ‚úì', 'success');
                return loadData();
            }).catch(function(error) {
                showToast('Fehler: ' + error.message, 'error');
            });
        }
        
        // CSV Import
        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            for (var i = 0; i < line.length; i++) {
                var char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function handleCSVUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                var text = e.target.result;
                var lines = text.split('\n').filter(function(line) { return line.trim(); });
                if (lines.length < 2) {
                    showToast('CSV muss mindestens Header und eine Datenzeile enthalten', 'error');
                    return;
                }
                var headers = parseCSVLine(lines[0]);
                var data = [];
                for (var i = 1; i < lines.length; i++) {
                    var values = parseCSVLine(lines[i]);
                    var row = {};
                    headers.forEach(function(header, index) {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
                state.csvData = data;
                showMappingDialog(headers);
            };
            reader.readAsText(file);
        }
        
        function showMappingDialog(csvHeaders) {
            var dbFields = ['begriff', 'reim', 'wortart', 'synonyme', 'bedeutung', 'beispielsatz', 'bemerkung', 'kategorie'];
            var dbLabels = {
                begriff: 'Begriff (Pflichtfeld)',
                reim: 'Reim',
                wortart: 'Wortart',
                synonyme: 'Synonyme',
                bedeutung: 'Bedeutung',
                beispielsatz: 'Beispielsatz',
                bemerkung: 'Bemerkung',
                kategorie: 'Kategorie'
            };
            var content = '<div class="info-box"><strong>‚ÑπÔ∏è CSV-Import Zuordnung</strong><br>Ordne die CSV-Spalten den Datenbank-Feldern zu.</div>';
            dbFields.forEach(function(field) {
                content += '<div class="mapping-grid"><div><label style="font-weight: 600;">' + dbLabels[field] + '</label></div>';
                content += '<div class="mapping-arrow">‚Üí</div>';
                content += '<select class="input" id="map-' + field + '"><option value="">-- Nicht zuordnen --</option>';
                csvHeaders.forEach(function(h) {
                    content += '<option value="' + h + '">' + h + '</option>';
                });
                content += '</select></div>';
            });
            content += '<div style="margin-top: 20px; display: flex; gap: 10px;">';
            content += '<button class="btn btn-success" onclick="executeImport()" style="flex: 1;">üì• ' + state.csvData.length + ' Eintr√§ge importieren</button>';
            content += '<button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>';
            content += '</div>';
            showModal('CSV-Import: Spalten zuordnen', content);
        }
        
        function executeImport() {
            var dbFields = ['begriff', 'reim', 'wortart', 'synonyme', 'bedeutung', 'beispielsatz', 'bemerkung', 'kategorie'];
            var mapping = {};
            dbFields.forEach(function(field) {
                var select = document.getElementById('map-' + field);
                if (select && select.value) {
                    mapping[field] = select.value;
                }
            });
            if (!mapping.begriff) {
                showToast('Das Feld "Begriff" muss zugeordnet werden!', 'error');
                return;
            }
            closeModal();
            var content = document.getElementById('content');
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 20px;">Importiere Daten...</p><div class="progress-bar" style="width: 400px; margin: 20px auto;"><div class="progress-fill" id="import-progress" style="width: 0%"></div></div><p id="import-status">0 / ' + state.csvData.length + '</p></div>';
            var imported = 0;
            var errors = 0;
            var total = state.csvData.length;
            var index = 0;
            function importNext() {
                if (index >= total) {
                    loadData().then(function() {
                        showToast('‚úì Import abgeschlossen: ' + imported + ' erfolgreich, ' + errors + ' Fehler', imported > 0 ? 'success' : 'error');
                    });
                    return;
                }
                var row = state.csvData[index];
                var data = {};
                dbFields.forEach(function(field) {
                    if (mapping[field] && row[mapping[field]]) {
                        data[field] = sanitizeInput(row[mapping[field]]);
                    } else {
                        data[field] = null;
                    }
                });
                if (!data.begriff || data.begriff.length < 2) {
                    errors++;
                    index++;
                    updateProgress();
                    importNext();
                    return;
                }
                supabaseCall('woerter', {
                    method: 'POST',
                    body: JSON.stringify(data)
                }).then(function() {
                    imported++;
                }).catch(function() {
                    errors++;
                }).finally(function() {
                    index++;
                    updateProgress();
                    importNext();
                });
            }
            function updateProgress() {
                var progress = (index / total) * 100;
                var progressEl = document.getElementById('import-progress');
                var statusEl = document.getElementById('import-status');
                if (progressEl) progressEl.style.width = progress + '%';
                if (statusEl) statusEl.textContent = index + ' / ' + total;
            }
            importNext();
        }
        
        // Info & Login
        function renderInfo() {
            return '<div class="info-content"><h2>√úber dieses W√∂rterbuch</h2><p>Dieses Mundart-W√∂rterbuch sammelt Dialektausdr√ºcke aus der Zentralschweiz und angrenzenden Regionen ‚Äì vor allem aus Luzern, Aargau, Solothurn und Bern.</p><h2>Mitmachen</h2><p>Du kennst einen Begriff, der hier fehlt? Unter "Mithelfen" kannst du neue W√∂rter vorschlagen.</p><h2>Kontakt</h2><p>Fragen oder Feedback? Schreib mir: <strong>info [at] ueliblum [punkt] ch</strong></p></div>';
        }
        
        function renderLogin() {
            return '<div class="login-box"><h2>Admin-Login</h2><form onsubmit="handleLogin(event); return false;"><input type="password" name="password" class="input" placeholder="Passwort" required><button type="submit" class="btn" style="width: 100%; margin-top: 15px;">Einloggen</button></form></div>';
        }
        
        function handleLogin(event) {
            event.preventDefault();
            var password = event.target.password.value;
            if (password === CONFIG.ADMIN_PASSWORD) {
                state.isAdmin = true;
                changeView('admin');
                showToast('Login erfolgreich! ‚úì', 'success');
            } else {
                showToast('Falsches Passwort!', 'error');
            }
        }
        
        // Event Listeners
        var debouncedSearch = debounce(function() {
            state.currentPage = 1;
            state.filter.buchstabe = '';
            loadPageData(1, state.filter).then(function() {
                render();
            });
        }, CONFIG.DEBOUNCE_DELAY);
        
        var debouncedReimSearch = debounce(function() {
            doReimSearch();
        }, CONFIG.DEBOUNCE_DELAY);
        
        function attachEventListeners() {
            var searchMundart = document.getElementById('search-mundart');
            var searchDeutsch = document.getElementById('search-deutsch');
            var searchWortart = document.getElementById('search-wortart');
            var searchReim = document.getElementById('search-reim');
            var toggleUnreine = document.getElementById('toggle-unreine');
            var adminSearch = document.getElementById('admin-search');
            
            if (searchMundart) {
                searchMundart.addEventListener('input', function(e) {
                    state.filter.mundart = e.target.value;
                    debouncedSearch();
                });
                searchMundart.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(state.searchDebounceTimer);
                        state.currentPage = 1;
                        state.filter.buchstabe = '';
                        loadPageData(1, state.filter).then(render);
                    }
                });
            }
            if (searchDeutsch) {
                searchDeutsch.addEventListener('input', function(e) {
                    state.filter.deutsch = e.target.value;
                    debouncedSearch();
                });
                searchDeutsch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(state.searchDebounceTimer);
                        state.currentPage = 1;
                        state.filter.buchstabe = '';
                        loadPageData(1, state.filter).then(render);
                    }
                });
            }
            if (searchWortart) {
                searchWortart.addEventListener('change', function(e) {
                    state.filter.wortart = e.target.value;
                    state.currentPage = 1;
                    loadPageData(1, state.filter).then(render);
                });
            }
            if (searchReim) {
                searchReim.addEventListener('input', function(e) {
                    state.filter.reim = e.target.value;
                    debouncedReimSearch();
                });
                searchReim.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(state.searchDebounceTimer);
                        doReimSearch();
                    }
                });
            }
            if (toggleUnreine) {
                toggleUnreine.addEventListener('change', function(e) {
                    state.showUnreineReime = e.target.checked;
                    doReimSearch();
                });
            }
            if (adminSearch) {
                adminSearch.addEventListener('input', function(e) {
                    state.filter.mundart = e.target.value;
                    debouncedSearch();
                });
            }
            var searchEditBegriff = document.getElementById('search-edit-begriff');
            if (searchEditBegriff) {
                searchEditBegriff.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') searchBegriffToEdit();
                });
            }
        }
        
        function render() {
            var content = document.getElementById('content');
            var views = {
                woerterbuch: renderWoerterbuch,
                reimlexikon: renderReimlexikon,
                bearbeiten: renderBearbeiten,
                info: renderInfo,
                login: renderLogin,
                admin: renderAdmin
            };
            content.innerHTML = (views[state.currentView] || function() { return '<div class="empty">Seite nicht gefunden</div>'; })();
            attachEventListeners();
        }
        
        function initNav() {
            var nav = document.getElementById('mainNav');
            var views = [
                { id: 'woerterbuch', label: 'W√∂rterbuch' },
                { id: 'reimlexikon', label: 'Reimlexikon' },
                { id: 'bearbeiten', label: 'Mithelfen' },
                { id: 'info', label: 'Info & Kontakt' },
                { id: 'admin', label: 'Admin' }
            ];
            nav.innerHTML = views.map(function(v, i) {
                return '<button class="nav-btn' + (i === 0 ? ' active' : '') + '" onclick="changeView(\'' + v.id + '\')">' + v.label + '</button>';
            }).join('');
        }
        
        function changeView(view) {
            if (view === 'admin' && !state.isAdmin) view = 'login';
            state.currentView = view;
            state.currentPage = 1;
            state.filter.buchstabe = '';
            state.filter.kategorie = '';
            if (view === 'bearbeiten') {
                state.isNewEntry = true;
                state.currentEditWord = null;
            }
            if (view === 'reimlexikon') {
                reimResults = { rein: [], unrein: [] };
            }
            document.querySelectorAll('.nav-btn').forEach(function(btn) {
                var match = btn.getAttribute('onclick').match(/'(.+?)'/);
                var btnView = match ? match[1] : '';
                btn.classList.toggle('active', btnView === view || (view === 'login' && btnView === 'admin'));
            });
            if (view === 'woerterbuch' || view === 'admin') {
                loadPageData(1, state.filter).then(render);
            } else {
                render();
            }
        }
        
        function init() {
            loadTheme();
            initNav();
            loadData();
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>

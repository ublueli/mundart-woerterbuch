<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schweizer Mundart-W√∂rterbuch - Vollversion v2.6</title>
    <style>
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --text-light: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #2563eb;
            --accent-hover: #1d4ed8;
            --accent-light: #eff6ff;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
            --box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-muted: #9ca3af;
            --text-light: #6b7280;
            --border-color: #374151;
            --accent-light: #1e3a5f;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.3);
            --box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); transition: background 0.3s, color 0.3s; }
        .header { background: var(--bg-secondary); box-shadow: var(--box-shadow); padding: 0; position: sticky; top: 0; z-index: 100; }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .header h1 { text-align: center; color: var(--text-primary); font-size: 24px; }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .theme-toggle { background: var(--bg-tertiary); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 18px; transition: background 0.2s; }
        .theme-toggle:hover { background: var(--border-color); }
        .nav { display: flex; justify-content: center; background: var(--bg-primary); flex-wrap: wrap; }
        .nav-btn { padding: 15px 30px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-size: 16px; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .nav-btn:hover { color: var(--accent-color); background: var(--accent-light); }
        .nav-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); background: var(--bg-secondary); }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        
        /* Hero Section - kleiner */
        .hero-section { display: flex; gap: 20px; margin-bottom: 20px; align-items: stretch; flex-wrap: wrap; }
        .stat-box { background: var(--accent-color); color: white; padding: 15px 25px; border-radius: 10px; display: flex; align-items: center; gap: 15px; }
        .stat-box .number { font-size: 28px; font-weight: 700; }
        .stat-box .label { font-size: 14px; opacity: 0.9; }
        .wort-des-tages { background: var(--bg-secondary); padding: 15px 20px; border-radius: 10px; box-shadow: var(--box-shadow); border-left: 4px solid var(--warning-color); flex: 1; min-width: 300px; }
        .wort-des-tages-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 10px; }
        .wort-des-tages h3 { color: var(--warning-color); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .wort-des-tages .begriff { font-size: 22px; color: var(--accent-color); font-weight: 700; }
        .wort-des-tages .bedeutung { color: var(--text-secondary); font-size: 14px; }
        
        /* Shuffle Button kleiner */
        .shuffle-btn { background: var(--success-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: transform 0.2s; }
        .shuffle-btn:hover { transform: scale(1.05); }
        
        /* Alphabet Navigation */
        .alphabet-nav { background: var(--bg-secondary); padding: 12px; border-radius: 10px; box-shadow: var(--box-shadow); margin-bottom: 15px; overflow-x: auto; white-space: nowrap; }
        .alphabet-btn { display: inline-block; width: 32px; height: 32px; line-height: 32px; text-align: center; background: var(--bg-tertiary); border: none; border-radius: 5px; cursor: pointer; font-weight: 600; color: var(--text-secondary); margin: 2px; transition: all 0.2s; font-size: 14px; }
        .alphabet-btn:hover { background: var(--accent-color); color: white; }
        .alphabet-btn.active { background: var(--accent-color); color: white; }
        
        .search-box { background: var(--bg-secondary); padding: 20px; border-radius: 10px; box-shadow: var(--box-shadow); margin-bottom: 20px; }
        .search-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 10px; }
        .form-grid { display: grid; gap: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .input { width: 100%; padding: 10px 12px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 14px; transition: border 0.2s; background: var(--bg-secondary); color: var(--text-primary); }
        .input:focus { outline: none; border-color: var(--accent-color); }
        select.input { cursor: pointer; }
        textarea.input { min-height: 100px; font-family: inherit; resize: vertical; }
        .btn { padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; }
        .btn:hover { background: var(--accent-hover); }
        .btn:disabled { background: #d1d5db; cursor: not-allowed; }
        .btn-secondary { background: var(--text-muted); }
        .btn-secondary:hover:not(:disabled) { background: var(--text-secondary); }
        .btn-danger { background: var(--danger-color); }
        .btn-success { background: var(--success-color); }
        .btn-small { padding: 6px 12px; font-size: 13px; }
        .card { background: var(--bg-secondary); padding: 18px; margin-bottom: 12px; border-radius: 8px; box-shadow: var(--card-shadow); cursor: pointer; transition: box-shadow 0.2s; }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .card h3 { color: var(--accent-color); margin-bottom: 10px; font-size: 18px; }
        .card-row { margin: 6px 0; color: var(--text-secondary); line-height: 1.5; font-size: 14px; }
        .card-label { font-weight: 600; color: var(--text-primary); }
        .card-kategorie { display: inline-block; background: var(--accent-light); color: var(--accent-color); padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; margin-top: 8px; }
        .empty { text-align: center; padding: 50px 20px; color: var(--text-light); font-size: 15px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .warning-box { background: #fef3c7; border: 2px solid var(--warning-color); padding: 12px; border-radius: 6px; margin-bottom: 12px; color: #92400e; font-size: 14px; }
        .success-box { background: #d1fae5; border: 2px solid var(--success-color); padding: 12px; border-radius: 6px; margin-bottom: 12px; color: #065f46; font-size: 14px; }
        .error-box { background: #fee2e2; border: 2px solid var(--danger-color); padding: 12px; border-radius: 6px; margin-bottom: 12px; color: #991b1b; }
        .info-box { background: #dbeafe; border: 2px solid #3b82f6; padding: 12px; border-radius: 6px; margin-bottom: 12px; color: #1e40af; font-size: 14px; }
        .info-content { background: var(--bg-secondary); padding: 25px; border-radius: 10px; box-shadow: var(--box-shadow); }
        .info-content h2 { color: var(--accent-color); margin: 20px 0 12px 0; font-size: 20px; }
        .info-content h2:first-child { margin-top: 0; }
        .info-content p { margin-bottom: 12px; line-height: 1.6; color: var(--text-secondary); }
        .pending-badge { background: #fbbf24; color: white; padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 600; margin-left: 8px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-size: 14px; font-weight: 500; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .page-btn { padding: 6px 12px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 5px; cursor: pointer; color: var(--text-muted); font-weight: 500; font-size: 13px; }
        .page-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .page-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .spinner { border: 3px solid var(--border-color); border-top: 3px solid var(--accent-color); border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--text-primary); color: var(--bg-primary); padding: 12px 18px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease-out; max-width: 350px; font-size: 14px; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { background: var(--success-color); color: white; }
        .toast.error { background: var(--danger-color); color: white; }
        .toast.warning { background: var(--warning-color); color: white; }
        .login-box { max-width: 360px; margin: 80px auto; background: var(--bg-secondary); padding: 30px; border-radius: 10px; box-shadow: var(--box-shadow); }
        .login-box h2 { margin-bottom: 20px; color: var(--text-primary); }
        .admin-table-container { width: 100%; overflow-x: auto; margin-top: 15px; background: var(--bg-secondary); border-radius: 6px; box-shadow: var(--box-shadow); max-height: 65vh; overflow-y: auto; }
        .admin-table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 900px; }
        .admin-table thead { background: var(--bg-tertiary); position: sticky; top: 0; z-index: 10; }
        .admin-table th { padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color); font-weight: 600; font-size: 13px; }
        .admin-table td { padding: 8px; border-bottom: 1px solid var(--border-color); font-size: 13px; vertical-align: top; }
        .admin-table tr:hover { background: var(--bg-tertiary); }
        .editable-cell { cursor: text; border: 1px solid transparent; padding: 4px; border-radius: 4px; min-height: 24px; }
        .editable-cell:focus { outline: none; border-color: var(--accent-color); background: var(--bg-secondary); }
        .editable-cell:hover { border-color: var(--border-color); }
        .delete-row-btn { background: var(--danger-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); padding: 25px; border-radius: 10px; max-width: 650px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-close { background: var(--bg-tertiary); border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; }
        .reim-section { margin: 15px 0; }
        .reim-section h3 { color: var(--accent-color); margin-bottom: 12px; font-size: 18px; padding-left: 10px; border-left: 3px solid var(--accent-color); }
        .search-hint { font-size: 12px; color: var(--text-light); margin-top: 6px; }
        
        /* Navigation f√ºr Bearbeiten */
        .edit-navigation { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 15px; }
        .edit-nav-info { font-weight: 500; color: var(--text-secondary); text-align: center; font-size: 14px; }
        .edit-nav-buttons { display: flex; gap: 8px; }
        
        /* √Ñhnliche W√∂rter */
        .similar-words { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .similar-words h4 { color: var(--text-muted); font-size: 13px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .similar-word-chip { display: inline-block; padding: 4px 10px; background: var(--bg-tertiary); border-radius: 12px; margin: 3px; font-size: 12px; color: var(--accent-color); cursor: pointer; transition: background 0.2s; }
        .similar-word-chip:hover { background: var(--accent-light); }
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .nav-btn { padding: 10px 15px; font-size: 14px; }
            .search-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .hero-section { flex-direction: column; }
            .header h1 { font-size: 18px; }
            .edit-navigation { flex-direction: column; gap: 10px; }
            .edit-nav-buttons { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div></div>
            <h1>üó£Ô∏è Schweizer Mundart-W√∂rterbuch</h1>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" title="Dark/Light Mode">üåô</button>
            </div>
        </div>
        <p style="text-align: center; color: var(--text-muted); padding: 0 20px 12px; border-bottom: 1px solid var(--border-color); font-size: 14px;">
            Dialekte aus Luzern, Aargau, Solothurn und Bern - v2.5
        </p>
        <div class="nav" id="mainNav"></div>
    </div>
    <div class="container" id="content"></div>
    <div id="toastContainer"></div>
    <div id="modal" class="modal"></div>
    <script>
        var CONFIG = {
            SUPABASE_URL: 'https://owigtnvkqrhclqhfppxf.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93aWd0bnZrcXJoY2xxaGZwcHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjQyOTIsImV4cCI6MjA3NjIwMDI5Mn0.gN0tNzN73oa9Fr-zoFgLGlkat4SypGV5B3bzdZjYFyo',
            ADMIN_PASSWORD: 'mundart2024',
            ITEMS_PER_PAGE: 50,
            DEBOUNCE_DELAY: 400
        };
        
        var state = {
            currentView: 'woerterbuch',
            adminTab: 'freigaben',
            isAdmin: false,
            currentPageData: [],
            totalCount: 0,
            pendingChanges: [],
            currentPage: 1,
            currentEditIndex: 0,
            currentEditWord: null,
            allWordsForEdit: [],
            allWordsLoaded: false,
            isNewEntry: false,
            showUnreineReime: false,
            filter: { mundart: '', deutsch: '', wortart: '', reim: '', kategorie: '', buchstabe: '' },
            searchDebounceTimer: null,
            wortarten: [],
            kategorien: [],
            isLoading: false,
            wortDesTages: null,
            darkMode: false
        };
        
        function toggleTheme() {
            state.darkMode = !state.darkMode;
            document.documentElement.setAttribute('data-theme', state.darkMode ? 'dark' : 'light');
            document.querySelector('.theme-toggle').textContent = state.darkMode ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', state.darkMode);
        }
        
        function loadTheme() {
            if (localStorage.getItem('darkMode') === 'true') {
                state.darkMode = true;
                document.documentElement.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
        }
        
        function debounce(func, delay) {
            return function() {
                var args = arguments, context = this;
                clearTimeout(state.searchDebounceTimer);
                state.searchDebounceTimer = setTimeout(function() { func.apply(context, args); }, delay);
            };
        }
        
        function showToast(message, type) {
            var container = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 3000);
        }
        
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim().replace(/[<>]/g, '');
        }
        
        function showModal(title, content) {
            var modal = document.getElementById('modal');
            modal.innerHTML = '<div class="modal-content"><div class="modal-header"><h2>' + title + '</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>' + content + '</div>';
            modal.classList.add('active');
        }
        
        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        
        // API
        function supabaseCall(endpoint, options) {
            options = options || {};
            return fetch(CONFIG.SUPABASE_URL + '/rest/v1/' + endpoint, {
                method: options.method || 'GET',
                headers: Object.assign({
                    'apikey': CONFIG.SUPABASE_KEY,
                    'Authorization': 'Bearer ' + CONFIG.SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': options.headers && options.headers['Prefer'] ? options.headers['Prefer'] : 'return=representation'
                }, options.headers || {}),
                body: options.body
            }).then(function(res) {
                var totalCount = res.headers.get('content-range');
                if (totalCount) {
                    var match = totalCount.match(/\/(\d+)/);
                    if (match) state.totalCount = parseInt(match[1]);
                }
                if (!res.ok) return res.text().then(function(e) { throw new Error('HTTP ' + res.status + ': ' + e); });
                if (options.method === 'DELETE' || res.status === 204) return { success: true };
                return res.text().then(function(t) { return t ? JSON.parse(t) : {}; });
            });
        }
        
        function loadPageData(page, filters) {
            state.isLoading = true;
            var offset = (page - 1) * CONFIG.ITEMS_PER_PAGE;
            var queryParts = [];
            
            if (filters.mundart && filters.mundart.trim()) queryParts.push('begriff=ilike.*' + encodeURIComponent(filters.mundart.trim()) + '*');
            if (filters.deutsch && filters.deutsch.trim()) queryParts.push('synonyme=ilike.*' + encodeURIComponent(filters.deutsch.trim()) + '*');
            if (filters.wortart && filters.wortart !== 'alle') queryParts.push('wortart=eq.' + encodeURIComponent(filters.wortart));
            if (filters.kategorie && filters.kategorie !== 'alle') queryParts.push('kategorie=eq.' + encodeURIComponent(filters.kategorie));
            if (filters.buchstabe && filters.buchstabe.trim()) queryParts.push('begriff=ilike.' + encodeURIComponent(filters.buchstabe) + '*');
            
            var url = 'woerter?select=*&order=begriff.asc&limit=' + CONFIG.ITEMS_PER_PAGE + '&offset=' + offset;
            if (queryParts.length > 0) url += '&' + queryParts.join('&');
            
            return supabaseCall(url, { headers: { 'Prefer': 'count=exact' } }).then(function(data) {
                state.currentPageData = data || [];
                state.isLoading = false;
                return data;
            });
        }
        
        // Lade ALLE Wortarten mit robustem Batch-Loading
        function loadWortarten() {
            var allWortarten = [];
            var pageSize = 1000;
            var offset = 0;
            
            function loadBatch() {
                return supabaseCall('woerter?select=wortart&limit=' + pageSize + '&offset=' + offset).then(function(batch) {
                    if (batch && batch.length > 0) {
                        allWortarten = allWortarten.concat(batch);
                        offset += pageSize;
                        if (batch.length === pageSize) {
                            return loadBatch(); // Mehr Daten vorhanden
                        }
                    }
                    return allWortarten;
                });
            }
            
            return loadBatch().then(function(data) {
                var unique = {};
                (data || []).forEach(function(item) {
                    if (item.wortart && item.wortart.trim() && item.wortart.trim() !== 'NULL') {
                        unique[item.wortart.trim()] = true;
                    }
                });
                state.wortarten = Object.keys(unique).sort();
                console.log('Wortarten geladen:', state.wortarten.length, state.wortarten);
                return state.wortarten;
            });
        }
        
        // Lade ALLE Kategorien mit robustem Batch-Loading
        function loadKategorien() {
            var allKategorien = [];
            var pageSize = 1000;
            var offset = 0;
            
            function loadBatch() {
                return supabaseCall('woerter?select=kategorie&limit=' + pageSize + '&offset=' + offset).then(function(batch) {
                    if (batch && batch.length > 0) {
                        allKategorien = allKategorien.concat(batch);
                        offset += pageSize;
                        if (batch.length === pageSize) {
                            return loadBatch(); // Mehr Daten vorhanden
                        }
                    }
                    return allKategorien;
                });
            }
            
            return loadBatch().then(function(data) {
                var unique = {};
                (data || []).forEach(function(item) {
                    if (item.kategorie && item.kategorie.trim() && item.kategorie.trim() !== 'NULL') {
                        // Kategorien k√∂nnen mehrere Werte haben (comma-separated)
                        var kats = item.kategorie.split(',');
                        kats.forEach(function(k) {
                            var trimmed = k.trim();
                            if (trimmed) unique[trimmed] = true;
                        });
                    }
                });
                state.kategorien = Object.keys(unique).sort();
                console.log('Kategorien geladen:', state.kategorien.length, state.kategorien);
                return state.kategorien;
            });
        }
        
        function loadTotalCount() {
            return supabaseCall('woerter?select=id&limit=1', { headers: { 'Prefer': 'count=exact' } });
        }
        
        function loadWortDesTages() {
            var today = new Date();
            var dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            var seed = today.getFullYear() * 1000 + dayOfYear;
            var offset = seed % Math.max(1, state.totalCount - 1);
            return supabaseCall('woerter?select=*&limit=1&offset=' + offset).then(function(data) {
                if (data && data.length > 0) state.wortDesTages = data[0];
                return state.wortDesTages;
            });
        }
        
        function loadRandomWord() {
            var randomOffset = Math.floor(Math.random() * Math.max(1, state.totalCount - 1));
            supabaseCall('woerter?select=*&limit=1&offset=' + randomOffset).then(function(data) {
                if (data && data.length > 0) showWordDetail(data[0]);
            });
        }
        
        // √Ñhnliche W√∂rter - NUR basierend auf Synonymen (Kategorie-Matching entfernt)
        function loadSimilarWords(wort) {
            var promises = [];
            
            // Suche nach gleichen Synonymen - nur ganze W√∂rter mit mindestens 4 Zeichen
            if (wort.synonyme) {
                var synonymList = wort.synonyme.split(/[,;]/).map(function(s) { return s.trim().toLowerCase(); });
                synonymList.forEach(function(syn) {
                    // Nur Synonyme mit mindestens 4 Zeichen und max 3 Abfragen
                    if (syn.length >= 4 && promises.length < 3) {
                        promises.push(
                            supabaseCall('woerter?select=*&synonyme=ilike.*' + encodeURIComponent(syn) + '*&id=neq.' + wort.id + '&limit=5&order=begriff.asc')
                        );
                    }
                });
            }
            
            // KATEGORIE-MATCHING ENTFERNT - zeigte oft unpassende W√∂rter
            
            if (promises.length === 0) return Promise.resolve([]);
            
            return Promise.all(promises).then(function(results) {
                var allSimilar = [];
                var seen = {};
                results.forEach(function(result) {
                    (result || []).forEach(function(w) {
                        if (!seen[w.id]) {
                            seen[w.id] = true;
                            allSimilar.push(w);
                        }
                    });
                });
                return allSimilar.slice(0, 10);
            });
        }
        
        function showWordDetail(wort) {
            loadSimilarWords(wort).then(function(similar) {
                var content = renderCardContent(wort);
                
                if (similar.length > 0) {
                    content += '<div class="similar-words"><h4>üìö W√∂rter mit √§hnlicher Bedeutung</h4>';
                    similar.forEach(function(w) {
                        content += '<span class="similar-word-chip" onclick="closeModal(); setTimeout(function() { showWordDetailById(' + w.id + '); }, 100);">' + w.begriff + '</span>';
                    });
                    content += '</div>';
                }
                
                showModal('üìñ ' + wort.begriff, content);
            });
        }
        
        function showWordDetailById(id) {
            supabaseCall('woerter?id=eq.' + id).then(function(data) {
                if (data && data.length > 0) showWordDetail(data[0]);
            });
        }
        
        function loadPendingChanges() {
            return supabaseCall('pending_changes?select=*&order=created_at.desc').then(function(data) {
                state.pendingChanges = data || [];
                return data;
            });
        }
        
        function loadAllWordsForEdit() {
            if (state.allWordsLoaded) return Promise.resolve(state.allWordsForEdit);
            showToast('Lade alle W√∂rter...', 'warning');
            var allData = [];
            var pageSize = 1000;
            var offset = 0;
            function loadBatch() {
                return supabaseCall('woerter?select=id,begriff&order=begriff.asc&limit=' + pageSize + '&offset=' + offset).then(function(batch) {
                    if (batch && batch.length > 0) {
                        allData = allData.concat(batch);
                        offset += pageSize;
                        if (batch.length < pageSize) return allData;
                        return loadBatch();
                    }
                    return allData;
                });
            }
            return loadBatch().then(function(data) {
                state.allWordsForEdit = data;
                state.allWordsLoaded = true;
                showToast(data.length + ' W√∂rter geladen', 'success');
                return data;
            });
        }
        
        function loadData() {
            var content = document.getElementById('content');
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 15px;">Lade Daten...</p></div>';
            
            Promise.all([
                loadTotalCount(),
                loadWortarten(),
                loadKategorien(),
                loadPendingChanges(),
                loadPageData(1, state.filter)
            ]).then(function() {
                return loadWortDesTages();
            }).then(render).catch(function(error) {
                console.error('Ladefehler:', error);
                document.getElementById('content').innerHTML = '<div class="error-box"><h2>‚ö†Ô∏è Verbindungsfehler</h2><p>' + error.message + '</p><button class="btn" onclick="loadData()">üîÑ Erneut versuchen</button></div>';
            });
        }
        
        // Reimlexikon
        function searchReime(searchTerm) {
            if (!searchTerm || !searchTerm.trim()) return Promise.resolve({ rein: [] });
            var normalizedSearch = searchTerm.toLowerCase().trim();
            return supabaseCall('woerter?select=*&begriff=ilike.' + encodeURIComponent(normalizedSearch) + '&limit=1').then(function(searchResult) {
                var searchReim = normalizedSearch;
                if (searchResult && searchResult.length > 0 && searchResult[0].reim) searchReim = searchResult[0].reim.toLowerCase().trim();
                if (!searchReim) return { rein: [] };
                return supabaseCall('woerter?select=*&reim=ilike.' + encodeURIComponent(searchReim) + '&order=begriff.asc&limit=200').then(function(reineReime) {
                    var rein = (reineReime || []).filter(function(w) { return w.begriff.toLowerCase().trim() !== normalizedSearch; });
                    return { rein: rein };
                });
            });
        }
        
        function exportAllCSV() {
            showToast('Exportiere...', 'warning');
            var allData = [], pageSize = 1000, offset = 0;
            function loadBatch() {
                return supabaseCall('woerter?select=*&order=begriff.asc&limit=' + pageSize + '&offset=' + offset).then(function(batch) {
                    if (batch && batch.length > 0) { allData = allData.concat(batch); offset += pageSize; if (batch.length < pageSize) return allData; return loadBatch(); }
                    return allData;
                });
            }
            loadBatch().then(function(data) {
                var headers = ['Begriff', 'Reim', 'Wortart', 'Synonyme', 'Bedeutung', 'Beispielsatz', 'Bemerkung', 'Kategorie'];
                var rows = [headers];
                data.forEach(function(w) { rows.push([w.begriff||'', w.reim||'', w.wortart||'', w.synonyme||'', w.bedeutung||'', w.beispielsatz||'', w.bemerkung||'', w.kategorie||'']); });
                var csvContent = rows.map(function(row) { return row.map(function(cell) { var str = String(cell).replace(/"/g, '""'); return str.includes(',') || str.includes('"') || str.includes('\n') ? '"' + str + '"' : str; }).join(','); }).join('\n');
                var blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                var link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'mundart-export-' + data.length + '.csv'; link.click();
                showToast('‚úì ' + data.length + ' exportiert!', 'success');
            });
        }
        
        function changePage(page) {
            var totalPages = Math.ceil(state.totalCount / CONFIG.ITEMS_PER_PAGE);
            state.currentPage = Math.max(1, Math.min(page, totalPages));
            window.scrollTo(0, 0);
            loadPageData(state.currentPage, state.filter).then(render);
        }
        
        function filterByBuchstabe(buchstabe) {
            state.filter.buchstabe = buchstabe;
            state.currentPage = 1;
            loadPageData(1, state.filter).then(render);
        }
        
        function filterByKategorie() {
            var select = document.getElementById('search-kategorie');
            if (select) {
                state.filter.kategorie = select.value;
                state.currentPage = 1;
                loadPageData(1, state.filter).then(render);
            }
        }
        
        function filterByWortart() {
            var select = document.getElementById('search-wortart');
            if (select) {
                state.filter.wortart = select.value;
                state.currentPage = 1;
                loadPageData(1, state.filter).then(render);
            }
        }
        
        function renderCardContent(w) {
            var html = '<h3 style="color: var(--accent-color); font-size: 22px; margin-bottom: 12px;">' + (w.begriff || '') + '</h3>';
            if (w.reim) html += '<div class="card-row"><span class="card-label">Reim:</span> ' + w.reim + '</div>';
            if (w.wortart) html += '<div class="card-row"><span class="card-label">Wortart:</span> ' + w.wortart + '</div>';
            if (w.synonyme) html += '<div class="card-row"><span class="card-label">Synonyme:</span> ' + w.synonyme.replace(/\n/g, '<br>') + '</div>';
            if (w.bedeutung) html += '<div class="card-row"><span class="card-label">Bedeutung:</span> ' + w.bedeutung.replace(/\n/g, '<br>') + '</div>';
            if (w.beispielsatz) html += '<div class="card-row"><span class="card-label">Beispiel:</span> <em>"' + w.beispielsatz.replace(/\n/g, '<br>') + '"</em></div>';
            if (w.bemerkung) html += '<div class="card-row"><span class="card-label">Bemerkung:</span> ' + w.bemerkung.replace(/\n/g, '<br>') + '</div>';
            if (w.kategorie) html += '<div class="card-kategorie">' + w.kategorie + '</div>';
            return html;
        }
        
        function renderCard(w) {
            var html = '<div class="card" onclick="showWordDetailById(' + w.id + ')"><h3>' + (w.begriff || '') + '</h3>';
            if (w.reim) html += '<div class="card-row"><span class="card-label">Reim:</span> ' + w.reim + '</div>';
            if (w.wortart) html += '<div class="card-row"><span class="card-label">Wortart:</span> ' + w.wortart + '</div>';
            if (w.synonyme) html += '<div class="card-row"><span class="card-label">Synonyme:</span> ' + w.synonyme + '</div>';
            if (w.bedeutung) html += '<div class="card-row"><span class="card-label">Bedeutung:</span> ' + w.bedeutung + '</div>';
            if (w.kategorie) html += '<div class="card-kategorie">' + w.kategorie + '</div>';
            html += '</div>';
            return html;
        }
        
        // W√∂rterbuch View
        function renderWoerterbuch() {
            var totalPages = Math.ceil(state.totalCount / CONFIG.ITEMS_PER_PAGE);
            
            // Hero Section - kleiner
            var html = '<div class="hero-section">';
            html += '<div class="stat-box"><span class="number">' + state.totalCount.toLocaleString('de-CH') + '</span><span class="label">W√∂rter</span></div>';
            if (state.wortDesTages) {
                html += '<div class="wort-des-tages"><div class="wort-des-tages-header"><h3>‚≠ê Wort des Tages</h3><button class="shuffle-btn" onclick="loadRandomWord()">üé≤ Zuf√§llig</button></div>';
                html += '<span class="begriff">' + state.wortDesTages.begriff + '</span> - ';
                html += '<span class="bedeutung">' + (state.wortDesTages.synonyme || state.wortDesTages.bedeutung || '').substring(0, 80) + '</span></div>';
            }
            html += '</div>';
            
            // Alphabet Navigation
            html += '<div class="alphabet-nav">';
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ√Ñ√ñ√ú'.split('').forEach(function(letter) {
                html += '<button class="alphabet-btn' + (state.filter.buchstabe.toUpperCase() === letter ? ' active' : '') + '" onclick="filterByBuchstabe(\'' + letter + '\')">' + letter + '</button>';
            });
            html += '<button class="alphabet-btn' + (!state.filter.buchstabe ? ' active' : '') + '" onclick="filterByBuchstabe(\'\')">Alle</button>';
            html += '</div>';
            
            // Suchbox mit Dropdowns
            html += '<div class="search-box"><div class="search-grid">';
            html += '<input type="text" id="search-mundart" class="input" placeholder="Mundartbegriff..." value="' + state.filter.mundart + '">';
            html += '<input type="text" id="search-deutsch" class="input" placeholder="Deutsche Entsprechung..." value="' + state.filter.deutsch + '">';
            
            // Wortart Dropdown
            html += '<select id="search-wortart" class="input" onchange="filterByWortart()"><option value="alle">Alle Wortarten (' + state.wortarten.length + ')</option>';
            state.wortarten.forEach(function(w) {
                html += '<option value="' + w + '"' + (state.filter.wortart === w ? ' selected' : '') + '>' + w + '</option>';
            });
            html += '</select>';
            
            // Kategorie Dropdown
            html += '<select id="search-kategorie" class="input" onchange="filterByKategorie()"><option value="alle">Alle Kategorien (' + state.kategorien.length + ')</option>';
            state.kategorien.forEach(function(k) {
                html += '<option value="' + k + '"' + (state.filter.kategorie === k ? ' selected' : '') + '>' + k + '</option>';
            });
            html += '</select>';
            
            html += '</div>';
            html += '<div class="search-hint">üí° Klicke auf ein Wort um Details und √§hnliche W√∂rter zu sehen</div>';
            html += '<div style="margin-top: 8px; color: var(--text-muted); font-size: 13px;">' + state.totalCount + ' Eintr√§ge' + (totalPages > 1 ? ' (Seite ' + state.currentPage + '/' + totalPages + ')' : '') + '</div></div>';
            
            if (state.isLoading) {
                html += '<div class="loading"><div class="spinner"></div></div>';
            } else if (state.currentPageData.length === 0) {
                html += '<div class="empty">Keine Eintr√§ge gefunden</div>';
            } else {
                state.currentPageData.forEach(function(w) { html += renderCard(w); });
            }
            
            if (totalPages > 1) html += renderPagination(totalPages);
            return html;
        }
        
        function renderPagination(totalPages) {
            var html = '<div style="display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 20px; padding: 15px;">';
            if (state.currentPage > 1) html += '<button onclick="changePage(' + (state.currentPage - 1) + ')" class="page-btn">‚Üê Zur√ºck</button>';
            html += '<span style="padding: 0 10px; color: var(--text-muted); font-size: 13px;">' + state.currentPage + ' / ' + totalPages + '</span>';
            var startPage = Math.max(1, state.currentPage - 2);
            var endPage = Math.min(totalPages, state.currentPage + 2);
            for (var i = startPage; i <= endPage; i++) {
                html += '<button onclick="changePage(' + i + ')" class="page-btn' + (i === state.currentPage ? ' active' : '') + '">' + i + '</button>';
            }
            if (state.currentPage < totalPages) html += '<button onclick="changePage(' + (state.currentPage + 1) + ')" class="page-btn">Weiter ‚Üí</button>';
            html += '</div>';
            return html;
        }
        
        // Reimlexikon
        var reimResults = { rein: [] };
        var reimLoading = false;
        
        function renderReimlexikon() {
            var searchTerm = state.filter.reim || '';
            var html = '<div class="search-box">';
            html += '<input type="text" id="search-reim" class="input" placeholder="Mundartbegriff eingeben..." value="' + searchTerm + '">';
            html += '<div class="search-hint">üí° Dr√ºcke Enter oder warte kurz</div></div>';
            if (reimLoading) {
                html += '<div class="loading"><div class="spinner"></div></div>';
            } else if (searchTerm.trim()) {
                html += '<div class="reim-section"><h3>Reime (' + reimResults.rein.length + ')</h3>';
                if (reimResults.rein.length === 0) html += '<div class="empty">Keine Reime gefunden</div>';
                else reimResults.rein.forEach(function(w) { html += renderCard(w); });
                html += '</div>';
            } else {
                html += '<div class="empty">Gib einen Begriff ein</div>';
            }
            return html;
        }
        
        function doReimSearch() {
            var searchTerm = state.filter.reim;
            if (!searchTerm || !searchTerm.trim()) { reimResults = { rein: [] }; render(); return; }
            reimLoading = true; render();
            searchReime(searchTerm).then(function(results) { reimResults = results; reimLoading = false; render(); });
        }
        
        // Bearbeiten View
        function renderBearbeiten() {
            var wort = state.currentEditWord || {};
            var html = '<div class="success-box"><strong>‚ú® Hilf mit!</strong> Klicke "Alle W√∂rter laden" um alphabetisch durchzugehen.</div>';
            
            html += '<div class="search-box" style="margin-bottom: 15px;">';
            html += '<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px;">';
            html += '<input type="text" id="search-edit-begriff" class="input" placeholder="Begriff suchen..." style="flex: 1; min-width: 180px;">';
            html += '<button class="btn" onclick="searchBegriffToEdit()">üîç Suchen</button>';
            html += '<button class="btn btn-success" onclick="startNewEntry()">+ Neu</button>';
            html += '</div>';
            if (!state.allWordsLoaded) {
                html += '<button class="btn btn-secondary" onclick="loadAllWordsAndStartEdit()" style="width: 100%;">üìö Alle W√∂rter laden</button>';
            }
            html += '</div>';
            
            // Navigation
            if (state.allWordsLoaded && state.allWordsForEdit.length > 0) {
                html += '<div class="edit-navigation">';
                html += '<div class="edit-nav-buttons">';
                html += '<button class="btn btn-secondary btn-small" onclick="navigateEditAll(-10)"' + (state.currentEditIndex < 10 ? ' disabled' : '') + '>‚è™ -10</button>';
                html += '<button class="btn btn-secondary btn-small" onclick="navigateEditAll(-1)"' + (state.currentEditIndex <= 0 ? ' disabled' : '') + '>‚Üê</button>';
                html += '</div>';
                html += '<span class="edit-nav-info"><strong>' + (state.currentEditIndex + 1) + '</strong> / ' + state.allWordsForEdit.length + '</span>';
                html += '<div class="edit-nav-buttons">';
                html += '<button class="btn btn-secondary btn-small" onclick="navigateEditAll(1)"' + (state.currentEditIndex >= state.allWordsForEdit.length - 1 ? ' disabled' : '') + '>‚Üí</button>';
                html += '<button class="btn btn-secondary btn-small" onclick="navigateEditAll(10)"' + (state.currentEditIndex >= state.allWordsForEdit.length - 10 ? ' disabled' : '') + '>+10 ‚è©</button>';
                html += '</div>';
                html += '</div>';
                
                // Alphabet Sprung
                html += '<div class="alphabet-nav" style="margin-bottom: 15px;">';
                'ABCDEFGHIJKLMNOPQRSTUVWXYZ√Ñ√ñ√ú'.split('').forEach(function(letter) {
                    html += '<button class="alphabet-btn" onclick="jumpToLetter(\'' + letter + '\')">' + letter + '</button>';
                });
                html += '</div>';
            }
            
            // Formular
            if (state.currentEditWord || state.isNewEntry) {
                html += '<div class="search-box"><div class="toolbar">';
                html += '<h2 style="font-size: 18px;">' + (state.isNewEntry ? 'Neuer Begriff' : 'Bearbeiten: ' + (wort.begriff || '')) + '</h2>';
                html += '</div>';
                html += '<form id="edit-form" onsubmit="saveFormEntry(event); return false;"><div class="form-grid">';
                
                // Begriff - JETZT EDITIERBAR
                html += '<div><label style="font-size: 13px; color: var(--text-muted);">Begriff *</label>';
                html += '<input type="text" name="begriff" class="input" placeholder="Mundartbegriff" value="' + (wort.begriff || '') + '" required></div>';
                
                // Reim
                html += '<div><label style="font-size: 13px; color: var(--text-muted);">Reim</label>';
                html += '<input type="text" name="reim" class="input" placeholder="z.B. √§ndle" value="' + (wort.reim || '') + '"></div>';
                
                html += '<div class="form-row">';
                // Wortart
                html += '<div><label style="font-size: 13px; color: var(--text-muted);">Wortart</label>';
                html += '<select name="wortart" id="wortart-select" class="input" onchange="toggleCustomInput(\'wortart\')"><option value="">-- Ausw√§hlen --</option>';
                state.wortarten.forEach(function(w) {
                    html += '<option value="' + w + '"' + (wort.wortart === w ? ' selected' : '') + '>' + w + '</option>';
                });
                html += '<option value="__custom__">‚ûï Neue...</option></select>';
                html += '<input type="text" id="wortart-custom" class="input hidden" placeholder="Neue Wortart" style="margin-top: 8px;"></div>';
                
                // Kategorie
                html += '<div><label style="font-size: 13px; color: var(--text-muted);">Kategorie</label>';
                html += '<select name="kategorie" id="kategorie-select" class="input" onchange="toggleCustomInput(\'kategorie\')"><option value="">-- Ausw√§hlen --</option>';
                state.kategorien.forEach(function(k) {
                    html += '<option value="' + k + '"' + (wort.kategorie === k ? ' selected' : '') + '>' + k + '</option>';
                });
                html += '<option value="__custom__">‚ûï Neue...</option></select>';
                html += '<input type="text" id="kategorie-custom" class="input hidden" placeholder="Neue Kategorie" style="margin-top: 8px;"></div>';
                html += '</div>';
                
                html += '<div><label style="font-size: 13px; color: var(--text-muted);">Synonyme / Deutsche √úbersetzung</label>';
                html += '<textarea name="synonyme" class="input" rows="2">' + (wort.synonyme || '') + '</textarea></div>';
                html += '<div><label style="font-size: 13px; color: var(--text-muted);">Bedeutung</label>';
                html += '<textarea name="bedeutung" class="input" rows="3">' + (wort.bedeutung || '') + '</textarea></div>';
                html += '<div><label style="font-size: 13px; color: var(--text-muted);">Beispielsatz</label>';
                html += '<textarea name="beispielsatz" class="input" rows="2">' + (wort.beispielsatz || '') + '</textarea></div>';
                html += '<div><label style="font-size: 13px; color: var(--text-muted);">Bemerkungen</label>';
                html += '<textarea name="bemerkung" class="input" rows="2">' + (wort.bemerkung || '') + '</textarea></div>';
                
                html += '</div><div class="form-actions">';
                html += '<button type="submit" class="btn">' + (state.isNewEntry ? 'Vorschlagen' : '√Ñnderung vorschlagen') + '</button>';
                if (!state.isNewEntry && state.allWordsLoaded) {
                    html += '<button type="button" class="btn btn-secondary" onclick="saveAndNext()">Speichern & Weiter ‚Üí</button>';
                }
                html += '</div></form></div>';
            }
            
            return html;
        }
        
        function toggleCustomInput(field) {
            var select = document.getElementById(field + '-select');
            var customInput = document.getElementById(field + '-custom');
            if (select.value === '__custom__') { customInput.classList.remove('hidden'); customInput.focus(); }
            else { customInput.classList.add('hidden'); customInput.value = ''; }
        }
        
        function loadAllWordsAndStartEdit() {
            loadAllWordsForEdit().then(function() {
                if (state.allWordsForEdit.length > 0) {
                    state.currentEditIndex = 0;
                    loadWordForEdit(state.allWordsForEdit[0].id);
                }
            });
        }
        
        function loadWordForEdit(id) {
            supabaseCall('woerter?id=eq.' + id).then(function(data) {
                if (data && data.length > 0) { state.currentEditWord = data[0]; state.isNewEntry = false; render(); }
            });
        }
        
        function jumpToLetter(letter) {
            var index = state.allWordsForEdit.findIndex(function(w) { return w.begriff.toUpperCase().startsWith(letter); });
            if (index >= 0) { state.currentEditIndex = index; loadWordForEdit(state.allWordsForEdit[index].id); }
            else showToast('Keine W√∂rter mit ' + letter, 'warning');
        }
        
        function navigateEditAll(direction) {
            var newIndex = Math.max(0, Math.min(state.currentEditIndex + direction, state.allWordsForEdit.length - 1));
            if (newIndex !== state.currentEditIndex) { state.currentEditIndex = newIndex; loadWordForEdit(state.allWordsForEdit[newIndex].id); }
        }
        
        function searchBegriffToEdit() {
            var searchInput = document.getElementById('search-edit-begriff');
            if (!searchInput || !searchInput.value.trim()) { showToast('Begriff eingeben', 'warning'); return; }
            var searchTerm = searchInput.value.trim().toLowerCase();
            if (state.allWordsLoaded) {
                var index = state.allWordsForEdit.findIndex(function(w) { return w.begriff.toLowerCase().startsWith(searchTerm); });
                if (index >= 0) { state.currentEditIndex = index; loadWordForEdit(state.allWordsForEdit[index].id); return; }
            }
            supabaseCall('woerter?select=*&begriff=ilike.*' + encodeURIComponent(searchTerm) + '*&limit=1&order=begriff.asc').then(function(results) {
                if (results && results.length > 0) {
                    state.currentEditWord = results[0]; state.isNewEntry = false;
                    if (state.allWordsLoaded) {
                        var idx = state.allWordsForEdit.findIndex(function(w) { return w.id === results[0].id; });
                        if (idx >= 0) state.currentEditIndex = idx;
                    }
                    render(); showToast('"' + results[0].begriff + '" geladen', 'success');
                } else showToast('Nicht gefunden', 'warning');
            });
        }
        
        function startNewEntry() { state.isNewEntry = true; state.currentEditWord = null; render(); }
        
        function saveFormEntry(event) {
            event.preventDefault();
            var formData = new FormData(event.target);
            var begriff = formData.get('begriff').trim();
            if (!begriff || begriff.length < 2) { showToast('Begriff zu kurz', 'error'); return; }
            
            var wortart = formData.get('wortart');
            var wortartCustom = document.getElementById('wortart-custom');
            if (wortart === '__custom__' && wortartCustom && wortartCustom.value.trim()) wortart = wortartCustom.value.trim();
            else if (wortart === '__custom__') wortart = null;
            
            var kategorie = formData.get('kategorie');
            var kategorieCustom = document.getElementById('kategorie-custom');
            if (kategorie === '__custom__' && kategorieCustom && kategorieCustom.value.trim()) kategorie = kategorieCustom.value.trim();
            else if (kategorie === '__custom__') kategorie = null;
            
            var data = {
                action: state.isNewEntry ? 'create' : 'edit',
                wort_id: state.isNewEntry ? null : (state.currentEditWord ? state.currentEditWord.id : null),
                begriff: sanitizeInput(begriff),
                reim: sanitizeInput(formData.get('reim')) || null,
                wortart: wortart || null,
                kategorie: kategorie || null,
                synonyme: sanitizeInput(formData.get('synonyme')) || null,
                bedeutung: sanitizeInput(formData.get('bedeutung')) || null,
                beispielsatz: sanitizeInput(formData.get('beispielsatz')) || null,
                bemerkung: sanitizeInput(formData.get('bemerkung')) || null,
                status: 'pending',
                created_at: new Date().toISOString()
            };
            
            supabaseCall('pending_changes', { method: 'POST', body: JSON.stringify(data) }).then(function() {
                showToast(state.isNewEntry ? 'Vorgeschlagen! ‚úì' : '√Ñnderung vorgeschlagen! ‚úì', 'success');
                if (wortart && !state.wortarten.includes(wortart)) { state.wortarten.push(wortart); state.wortarten.sort(); }
                if (kategorie && !state.kategorien.includes(kategorie)) { state.kategorien.push(kategorie); state.kategorien.sort(); }
                return loadPendingChanges();
            }).then(render);
        }
        
        function saveAndNext() {
            var form = document.getElementById('edit-form');
            if (form) {
                saveFormEntry({ preventDefault: function(){}, target: form });
                setTimeout(function() { navigateEditAll(1); }, 500);
            }
        }
        
        // Admin
        function renderAdmin() {
            var pendingCount = state.pendingChanges.length;
            var tabs = '<div class="tabs">';
            tabs += '<button class="tab-btn' + (state.adminTab === 'freigaben' ? ' active' : '') + '" onclick="changeAdminTab(\'freigaben\')">Freigaben' + (pendingCount > 0 ? '<span class="pending-badge">' + pendingCount + '</span>' : '') + '</button>';
            tabs += '<button class="tab-btn' + (state.adminTab === 'tabelle' ? ' active' : '') + '" onclick="changeAdminTab(\'tabelle\')">Tabelle</button>';
            tabs += '<button class="tab-btn' + (state.adminTab === 'export' ? ' active' : '') + '" onclick="changeAdminTab(\'export\')">Export</button>';
            tabs += '</div>';
            if (state.adminTab === 'freigaben') return tabs + renderFreigaben(pendingCount);
            if (state.adminTab === 'tabelle') return tabs + renderAdminTable();
            return tabs + '<div class="search-box"><button class="btn btn-success" onclick="exportAllCSV()" style="width:100%;padding:12px;">üì• Export (' + state.totalCount + ')</button></div>';
        }
        
        function renderFreigaben(count) {
            var html = '<h2 style="margin-bottom:15px;">Ausstehend (' + count + ')</h2>';
            if (count > 0) html += '<button class="btn" onclick="approveAllChanges()" style="margin-bottom:15px;">‚úì Alle freigeben</button>';
            if (count === 0) return html + '<div class="empty">Keine √Ñnderungen</div>';
            state.pendingChanges.forEach(function(c) {
                html += '<div class="card" style="cursor:default;"><div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">';
                html += '<div><h3 style="margin:0;">' + c.begriff + '</h3><span class="pending-badge" style="margin-left:0;">' + (c.action === 'create' ? 'Neu' : 'Edit') + '</span></div>';
                html += '<div><button class="btn btn-small" onclick="approveChange(' + c.id + ')">‚úì</button> <button class="btn btn-danger btn-small" onclick="rejectChange(' + c.id + ')">‚úó</button></div></div>';
                if (c.wortart) html += '<div class="card-row"><span class="card-label">Wortart:</span> ' + c.wortart + '</div>';
                if (c.kategorie) html += '<div class="card-row"><span class="card-label">Kategorie:</span> ' + c.kategorie + '</div>';
                if (c.synonyme) html += '<div class="card-row"><span class="card-label">Synonyme:</span> ' + c.synonyme + '</div>';
                if (c.bedeutung) html += '<div class="card-row"><span class="card-label">Bedeutung:</span> ' + c.bedeutung + '</div>';
                html += '</div>';
            });
            return html;
        }
        
        function renderAdminTable() {
            var totalPages = Math.ceil(state.totalCount / CONFIG.ITEMS_PER_PAGE);
            var html = '<div class="search-box"><input type="text" id="admin-search" class="input" placeholder="Suchen..." value="' + state.filter.mundart + '"><div style="margin-top:8px;font-size:13px;color:var(--text-muted);">' + state.totalCount + ' Eintr√§ge</div></div>';
            html += '<div class="admin-table-container"><table class="admin-table"><thead><tr><th style="width:30px;">‚úó</th><th>Begriff</th><th>Reim</th><th>Wortart</th><th>Synonyme</th><th>Bedeutung</th><th>Kategorie</th></tr></thead><tbody>';
            state.currentPageData.forEach(function(w, i) {
                html += '<tr style="' + (i % 2 === 0 ? 'background:var(--bg-tertiary);' : '') + '">';
                html += '<td><button class="delete-row-btn" onclick="deleteRow(' + w.id + ')">‚úó</button></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ',\'begriff\',this.textContent.trim())" style="font-weight:600;">' + (w.begriff||'') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ',\'reim\',this.textContent.trim())">' + (w.reim||'') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ',\'wortart\',this.textContent.trim())">' + (w.wortart||'') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ',\'synonyme\',this.textContent.trim())">' + (w.synonyme||'') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ',\'bedeutung\',this.textContent.trim())">' + (w.bedeutung||'') + '</div></td>';
                html += '<td><div contenteditable="true" class="editable-cell" onblur="updateCell(' + w.id + ',\'kategorie\',this.textContent.trim())">' + (w.kategorie||'') + '</div></td>';
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            if (totalPages > 1) html += renderPagination(totalPages);
            return html;
        }
        
        function changeAdminTab(tab) { state.adminTab = tab; render(); }
        function updateCell(id, field, value) { var data = {}; data[field] = value || null; supabaseCall('woerter?id=eq.' + id, { method: 'PATCH', body: JSON.stringify(data) }); }
        function deleteRow(id) { if (!confirm('L√∂schen?')) return; supabaseCall('woerter?id=eq.' + id, { method: 'DELETE' }).then(function() { showToast('Gel√∂scht', 'success'); return loadPageData(state.currentPage, state.filter); }).then(function() { loadTotalCount(); render(); }); }
        
        function approveChange(id) {
            var c = state.pendingChanges.find(function(x) { return x.id === id; });
            if (!c) return;
            var p = c.action === 'create' 
                ? supabaseCall('woerter', { method: 'POST', body: JSON.stringify({ begriff: c.begriff, reim: c.reim, wortart: c.wortart, kategorie: c.kategorie, synonyme: c.synonyme, bedeutung: c.bedeutung, beispielsatz: c.beispielsatz, bemerkung: c.bemerkung }) })
                : supabaseCall('woerter?id=eq.' + c.wort_id, { method: 'PATCH', body: JSON.stringify({ begriff: c.begriff, reim: c.reim, wortart: c.wortart, kategorie: c.kategorie, synonyme: c.synonyme, bedeutung: c.bedeutung, beispielsatz: c.beispielsatz, bemerkung: c.bemerkung }) });
            p.then(function() { return supabaseCall('pending_changes?id=eq.' + id, { method: 'DELETE' }); }).then(function() { showToast('Freigegeben!', 'success'); return loadData(); });
        }
        
        function rejectChange(id) { if (!confirm('Ablehnen?')) return; supabaseCall('pending_changes?id=eq.' + id, { method: 'DELETE' }).then(function() { showToast('Abgelehnt', 'warning'); return loadPendingChanges(); }).then(render); }
        
        function approveAllChanges() {
            if (!confirm(state.pendingChanges.length + ' freigeben?')) return;
            Promise.all(state.pendingChanges.map(function(c) {
                var p = c.action === 'create'
                    ? supabaseCall('woerter', { method: 'POST', body: JSON.stringify({ begriff: c.begriff, reim: c.reim, wortart: c.wortart, kategorie: c.kategorie, synonyme: c.synonyme, bedeutung: c.bedeutung, beispielsatz: c.beispielsatz, bemerkung: c.bemerkung }) })
                    : supabaseCall('woerter?id=eq.' + c.wort_id, { method: 'PATCH', body: JSON.stringify({ begriff: c.begriff, reim: c.reim, wortart: c.wortart, kategorie: c.kategorie, synonyme: c.synonyme, bedeutung: c.bedeutung, beispielsatz: c.beispielsatz, bemerkung: c.bemerkung }) });
                return p.then(function() { return supabaseCall('pending_changes?id=eq.' + c.id, { method: 'DELETE' }); });
            })).then(function() { showToast('Alle freigegeben!', 'success'); return loadData(); });
        }
        
        function renderInfo() {
            return '<div class="info-content"><h2>√úber</h2><p>Mundart-W√∂rterbuch aus Luzern, Aargau, Solothurn und Bern.</p><h2>Mitmachen</h2><p>Unter "Mithelfen" kannst du W√∂rter erg√§nzen.</p><h2>Kontakt</h2><p>info [at] ueliblum [punkt] ch</p></div>';
        }
        
        function renderLogin() {
            return '<div class="login-box"><h2>Admin</h2><form onsubmit="handleLogin(event);return false;"><input type="password" name="password" class="input" placeholder="Passwort" required><button type="submit" class="btn" style="width:100%;margin-top:12px;">Login</button></form></div>';
        }
        
        function handleLogin(event) {
            event.preventDefault();
            if (event.target.password.value === CONFIG.ADMIN_PASSWORD) { state.isAdmin = true; changeView('admin'); showToast('Login OK', 'success'); }
            else showToast('Falsches Passwort', 'error');
        }
        
        var debouncedSearch = debounce(function() { state.currentPage = 1; state.filter.buchstabe = ''; loadPageData(1, state.filter).then(render); }, CONFIG.DEBOUNCE_DELAY);
        var debouncedReimSearch = debounce(doReimSearch, CONFIG.DEBOUNCE_DELAY);
        
        function attachEventListeners() {
            var el;
            el = document.getElementById('search-mundart');
            if (el) { el.addEventListener('input', function(e) { state.filter.mundart = e.target.value; debouncedSearch(); }); el.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.currentPage = 1; loadPageData(1, state.filter).then(render); }}); }
            el = document.getElementById('search-deutsch');
            if (el) el.addEventListener('input', function(e) { state.filter.deutsch = e.target.value; debouncedSearch(); });
            el = document.getElementById('search-reim');
            if (el) { el.addEventListener('input', function(e) { state.filter.reim = e.target.value; debouncedReimSearch(); }); el.addEventListener('keypress', function(e) { if (e.key === 'Enter') doReimSearch(); }); }
            el = document.getElementById('admin-search');
            if (el) el.addEventListener('input', function(e) { state.filter.mundart = e.target.value; debouncedSearch(); });
            el = document.getElementById('search-edit-begriff');
            if (el) el.addEventListener('keypress', function(e) { if (e.key === 'Enter') searchBegriffToEdit(); });
        }
        
        function render() {
            var content = document.getElementById('content');
            var views = { woerterbuch: renderWoerterbuch, reimlexikon: renderReimlexikon, bearbeiten: renderBearbeiten, info: renderInfo, login: renderLogin, admin: renderAdmin };
            content.innerHTML = (views[state.currentView] || function() { return '<div class="empty">?</div>'; })();
            attachEventListeners();
        }
        
        function initNav() {
            document.getElementById('mainNav').innerHTML = [
                { id: 'woerterbuch', label: 'W√∂rterbuch' },
                { id: 'reimlexikon', label: 'Reimlexikon' },
                { id: 'bearbeiten', label: 'Mithelfen' },
                { id: 'info', label: 'Info' },
                { id: 'admin', label: 'Admin' }
            ].map(function(v, i) { return '<button class="nav-btn' + (i === 0 ? ' active' : '') + '" onclick="changeView(\'' + v.id + '\')">' + v.label + '</button>'; }).join('');
        }
        
        function changeView(view) {
            if (view === 'admin' && !state.isAdmin) view = 'login';
            state.currentView = view;
            state.currentPage = 1;
            state.filter.buchstabe = '';
            state.filter.kategorie = '';
            state.filter.wortart = '';
            if (view === 'bearbeiten') { state.isNewEntry = false; state.currentEditWord = null; }
            if (view === 'reimlexikon') reimResults = { rein: [] };
            document.querySelectorAll('.nav-btn').forEach(function(btn) {
                var match = btn.getAttribute('onclick').match(/'(.+?)'/);
                btn.classList.toggle('active', match && (match[1] === view || (view === 'login' && match[1] === 'admin')));
            });
            if (view === 'woerterbuch' || view === 'admin') loadPageData(1, state.filter).then(render);
            else render();
        }
        
        function init() { loadTheme(); initNav(); loadData(); }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
        else init();
    </script>
</body>
</html>
